import { DIALOG_DATA, Dialog } from '@angular/cdk/dialog';
import { OverlayPositionBuilder, ScrollStrategyOptions } from '@angular/cdk/overlay';
import { Injectable, Injector, RendererFactory2, computed, effect, inject, runInInjectionContext, signal, } from '@angular/core';
import { Subject, filter, takeUntil } from 'rxjs';
import { BrnDialogRef } from './brn-dialog-ref';
import * as i0 from "@angular/core";
let dialogSequence = 0;
export const cssClassesToArray = (classes, defaultClass = '') => {
    if (typeof classes === 'string') {
        const splitClasses = classes.trim().split(' ');
        if (splitClasses.length === 0) {
            return [defaultClass];
        }
        return splitClasses;
    }
    return classes ?? [];
};
/** @deprecated `injectBrnDialogCtx` will no longer be supported once components are stable. Use `injectBrnDialogContext` instead.  */
export const injectBrnDialogCtx = () => {
    return inject(DIALOG_DATA);
};
// eslint-disable-next-line @typescript-eslint/no-explicit-any
export const injectBrnDialogContext = (options = {}) => {
    return inject(DIALOG_DATA, options);
};
export class BrnDialogService {
    constructor() {
        this._cdkDialog = inject(Dialog);
        this._rendererFactory = inject(RendererFactory2);
        this._renderer = this._rendererFactory.createRenderer(null, null);
        this._positionBuilder = inject(OverlayPositionBuilder);
        this._sso = inject(ScrollStrategyOptions);
        this._injector = inject(Injector);
    }
    open(content, vcr, context, options) {
        if (options?.id && this._cdkDialog.getDialogById(options.id)) {
            throw new Error(`Dialog with ID: ${options.id} already exists`);
        }
        const positionStrategy = options?.positionStrategy ??
            (options?.attachTo && options?.attachPositions && options?.attachPositions?.length > 0
                ? this._positionBuilder?.flexibleConnectedTo(options.attachTo).withPositions(options.attachPositions ?? [])
                : this._positionBuilder.global().centerHorizontally().centerVertically());
        let brnDialogRef;
        let effectRef;
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const contextOrData = {
            ...context,
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            close: (result = undefined) => brnDialogRef.close(result, options?.closeDelay),
        };
        const destroyed$ = new Subject();
        const open = signal(true);
        const state = computed(() => (open() ? 'open' : 'closed'));
        const dialogId = dialogSequence++;
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        const cdkDialogRef = this._cdkDialog.open(content, {
            id: options?.id ?? `brn-dialog-${dialogId}`,
            role: options?.role,
            viewContainerRef: vcr,
            templateContext: () => ({
                $implicit: contextOrData,
            }),
            data: contextOrData,
            hasBackdrop: options?.hasBackdrop,
            panelClass: cssClassesToArray(options?.panelClass),
            backdropClass: cssClassesToArray(options?.backdropClass, 'bg-transparent'),
            positionStrategy,
            scrollStrategy: options?.scrollStrategy ?? this._sso?.block(),
            restoreFocus: options?.restoreFocus,
            disableClose: true,
            autoFocus: options?.autoFocus ?? 'first-tabbable',
            ariaDescribedBy: options?.ariaDescribedBy ?? `brn-dialog-description-${dialogId}`,
            ariaLabelledBy: options?.ariaLabelledBy ?? `brn-dialog-title-${dialogId}`,
            ariaLabel: options?.ariaLabel,
            ariaModal: options?.ariaModal,
            providers: (cdkDialogRef) => {
                brnDialogRef = new BrnDialogRef(cdkDialogRef, open, state, dialogId, options);
                runInInjectionContext(this._injector, () => {
                    effectRef = effect(() => {
                        if (overlay) {
                            this._renderer.setAttribute(overlay, 'data-state', state());
                        }
                        if (backdrop) {
                            this._renderer.setAttribute(backdrop, 'data-state', state());
                        }
                    });
                });
                const providers = [
                    {
                        provide: BrnDialogRef,
                        useValue: brnDialogRef,
                    },
                ];
                if (options?.providers) {
                    if (typeof options.providers === 'function') {
                        providers.push(...options.providers());
                    }
                    if (Array.isArray(options.providers)) {
                        providers.push(...options.providers);
                    }
                }
                return providers;
            },
        });
        const overlay = cdkDialogRef.overlayRef.overlayElement;
        const backdrop = cdkDialogRef.overlayRef.backdropElement;
        if (options?.closeOnOutsidePointerEvents) {
            cdkDialogRef.outsidePointerEvents.pipe(takeUntil(destroyed$)).subscribe(() => {
                brnDialogRef.close(undefined, options?.closeDelay);
            });
        }
        if (options?.closeOnBackdropClick) {
            cdkDialogRef.backdropClick.pipe(takeUntil(destroyed$)).subscribe(() => {
                brnDialogRef.close(undefined, options?.closeDelay);
            });
        }
        if (!options?.disableClose) {
            cdkDialogRef.keydownEvents
                .pipe(filter((e) => e.key === 'Escape'), takeUntil(destroyed$))
                .subscribe(() => {
                brnDialogRef.close(undefined, options?.closeDelay);
            });
        }
        cdkDialogRef.closed.pipe(takeUntil(destroyed$)).subscribe(() => {
            effectRef?.destroy();
            destroyed$.next();
        });
        return brnDialogRef;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnDialogService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnDialogService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnDialogService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJuLWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy91aS9kaWFsb2cvYnJhaW4vc3JjL2xpYi9icm4tZGlhbG9nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUscUJBQXFCLEVBQXNCLE1BQU0sc0JBQXNCLENBQUM7QUFDekcsT0FBTyxFQUNOLFVBQVUsRUFDVixRQUFRLEVBQ1IsZ0JBQWdCLEVBQ2hCLFFBQVEsRUFDUixNQUFNLEVBQ04sTUFBTSxFQUNOLHFCQUFxQixFQUNyQixNQUFNLEdBTU4sTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWxELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7QUFHaEQsSUFBSSxjQUFjLEdBQUcsQ0FBQyxDQUFDO0FBRXZCLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBNkMsRUFBRSxZQUFZLEdBQUcsRUFBRSxFQUFZLEVBQUU7SUFDL0csSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUNqQyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUMvQixPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkIsQ0FBQztRQUNELE9BQU8sWUFBWSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxPQUFPLE9BQU8sSUFBSSxFQUFFLENBQUM7QUFDdEIsQ0FBQyxDQUFDO0FBS0Ysc0lBQXNJO0FBQ3RJ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QUNuQyxZQUFZLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNyRSxZQUFZLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDcEQsQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxDQUFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQztZQUM1QixZQUFZLENBQUMsYUFBYTtpQkFDeEIsSUFBSSxDQUNKLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxRQUFRLENBQUMsRUFDakMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUNyQjtpQkFDQSxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNmLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNwRCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQzlELFNBQVMsRUFBRSxPQUFPLEVBQUUsQ0FBQztZQUNyQixVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFlBQVksQ0FBQztJQUNyQixDQUFDOzhHQWhJVyxnQkFBZ0I7a0hBQWhCLGdCQUFnQixjQURILE1BQU07OzJGQUNuQixnQkFBZ0I7a0JBRDVCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRElBTE9HX0RBVEEsIERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9kaWFsb2cnO1xuaW1wb3J0IHsgT3ZlcmxheVBvc2l0aW9uQnVpbGRlciwgU2Nyb2xsU3RyYXRlZ3lPcHRpb25zLCB0eXBlIENvbXBvbmVudFR5cGUgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQge1xuXHRJbmplY3RhYmxlLFxuXHRJbmplY3Rvcixcblx0UmVuZGVyZXJGYWN0b3J5Mixcblx0Y29tcHV0ZWQsXG5cdGVmZmVjdCxcblx0aW5qZWN0LFxuXHRydW5JbkluamVjdGlvbkNvbnRleHQsXG5cdHNpZ25hbCxcblx0dHlwZSBFZmZlY3RSZWYsXG5cdHR5cGUgSW5qZWN0T3B0aW9ucyxcblx0dHlwZSBTdGF0aWNQcm92aWRlcixcblx0dHlwZSBUZW1wbGF0ZVJlZixcblx0dHlwZSBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QsIGZpbHRlciwgdGFrZVVudGlsIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgdHlwZSB7IEJybkRpYWxvZ09wdGlvbnMgfSBmcm9tICcuL2Jybi1kaWFsb2ctb3B0aW9ucyc7XG5pbXBvcnQgeyBCcm5EaWFsb2dSZWYgfSBmcm9tICcuL2Jybi1kaWFsb2ctcmVmJztcbmltcG9ydCB0eXBlIHsgQnJuRGlhbG9nU3RhdGUgfSBmcm9tICcuL2Jybi1kaWFsb2ctc3RhdGUnO1xuXG5sZXQgZGlhbG9nU2VxdWVuY2UgPSAwO1xuXG5leHBvcnQgY29uc3QgY3NzQ2xhc3Nlc1RvQXJyYXkgPSAoY2xhc3Nlczogc3RyaW5nIHwgc3RyaW5nW10gfCB1bmRlZmluZWQgfCBudWxsLCBkZWZhdWx0Q2xhc3MgPSAnJyk6IHN0cmluZ1tdID0+IHtcblx0aWYgKHR5cGVvZiBjbGFzc2VzID09PSAnc3RyaW5nJykge1xuXHRcdGNvbnN0IHNwbGl0Q2xhc3NlcyA9IGNsYXNzZXMudHJpbSgpLnNwbGl0KCcgJyk7XG5cdFx0aWYgKHNwbGl0Q2xhc3Nlcy5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybiBbZGVmYXVsdENsYXNzXTtcblx0XHR9XG5cdFx0cmV0dXJuIHNwbGl0Q2xhc3Nlcztcblx0fVxuXHRyZXR1cm4gY2xhc3NlcyA/PyBbXTtcbn07XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5leHBvcnQgdHlwZSBCcm5EaWFsb2dDb250ZXh0PFQ+ID0gVCAmIHsgY2xvc2U6IChyZXN1bHQ/OiBhbnkpID0+IHZvaWQgfTtcblxuLyoqIEBkZXByZWNhdGVkIGBpbmplY3RCcm5EaWFsb2dDdHhgIHdpbGwgbm8gbG9uZ2VyIGJlIHN1cHBvcnRlZCBvbmNlIGNvbXBvbmVudHMgYXJlIHN0YWJsZS4gVXNlIGBpbmplY3RCcm5EaWFsb2dDb250ZXh0YCBpbnN0ZWFkLiAgKi9cbmV4cG9ydCBjb25zdCBpbmplY3RCcm5EaWFsb2dDdHggPSA8VD4oKTogQnJuRGlhbG9nQ29udGV4dDxUPiA9PiB7XG5cdHJldHVybiBpbmplY3QoRElBTE9HX0RBVEEpO1xufTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbmV4cG9ydCBjb25zdCBpbmplY3RCcm5EaWFsb2dDb250ZXh0ID0gPERpYWxvZ0NvbnRleHQgPSBhbnk+KG9wdGlvbnM6IEluamVjdE9wdGlvbnMgPSB7fSkgPT4ge1xuXHRyZXR1cm4gaW5qZWN0KERJQUxPR19EQVRBLCBvcHRpb25zKSBhcyBEaWFsb2dDb250ZXh0O1xufTtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBCcm5EaWFsb2dTZXJ2aWNlIHtcblx0cHJpdmF0ZSByZWFkb25seSBfY2RrRGlhbG9nID0gaW5qZWN0KERpYWxvZyk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX3JlbmRlcmVyRmFjdG9yeSA9IGluamVjdChSZW5kZXJlckZhY3RvcnkyKTtcblx0cHJpdmF0ZSByZWFkb25seSBfcmVuZGVyZXIgPSB0aGlzLl9yZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX3Bvc2l0aW9uQnVpbGRlciA9IGluamVjdChPdmVybGF5UG9zaXRpb25CdWlsZGVyKTtcblx0cHJpdmF0ZSByZWFkb25seSBfc3NvID0gaW5qZWN0KFNjcm9sbFN0cmF0ZWd5T3B0aW9ucyk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2luamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcblxuXHRwdWJsaWMgb3BlbjxEaWFsb2dDb250ZXh0Pihcblx0XHRjb250ZW50OiBDb21wb25lbnRUeXBlPHVua25vd24+IHwgVGVtcGxhdGVSZWY8dW5rbm93bj4sXG5cdFx0dmNyPzogVmlld0NvbnRhaW5lclJlZixcblx0XHRjb250ZXh0PzogRGlhbG9nQ29udGV4dCxcblx0XHRvcHRpb25zPzogUGFydGlhbDxCcm5EaWFsb2dPcHRpb25zPixcblx0KSB7XG5cdFx0aWYgKG9wdGlvbnM/LmlkICYmIHRoaXMuX2Nka0RpYWxvZy5nZXREaWFsb2dCeUlkKG9wdGlvbnMuaWQpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYERpYWxvZyB3aXRoIElEOiAke29wdGlvbnMuaWR9IGFscmVhZHkgZXhpc3RzYCk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgcG9zaXRpb25TdHJhdGVneSA9XG5cdFx0XHRvcHRpb25zPy5wb3NpdGlvblN0cmF0ZWd5ID8/XG5cdFx0XHQob3B0aW9ucz8uYXR0YWNoVG8gJiYgb3B0aW9ucz8uYXR0YWNoUG9zaXRpb25zICYmIG9wdGlvbnM/LmF0dGFjaFBvc2l0aW9ucz8ubGVuZ3RoID4gMFxuXHRcdFx0XHQ/IHRoaXMuX3Bvc2l0aW9uQnVpbGRlcj8uZmxleGlibGVDb25uZWN0ZWRUbyhvcHRpb25zLmF0dGFjaFRvKS53aXRoUG9zaXRpb25zKG9wdGlvbnMuYXR0YWNoUG9zaXRpb25zID8/IFtdKVxuXHRcdFx0XHQ6IHRoaXMuX3Bvc2l0aW9uQnVpbGRlci5nbG9iYWwoKS5jZW50ZXJIb3Jpem9udGFsbHkoKS5jZW50ZXJWZXJ0aWNhbGx5KCkpO1xuXG5cdFx0bGV0IGJybkRpYWxvZ1JlZiE6IEJybkRpYWxvZ1JlZjtcblx0XHRsZXQgZWZmZWN0UmVmITogRWZmZWN0UmVmO1xuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0XHRjb25zdCBjb250ZXh0T3JEYXRhOiBCcm5EaWFsb2dDb250ZXh0PGFueT4gPSB7XG5cdFx0XHQuLi5jb250ZXh0LFxuXHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0XHRcdGNsb3NlOiAocmVzdWx0OiBhbnkgPSB1bmRlZmluZWQpID0+IGJybkRpYWxvZ1JlZi5jbG9zZShyZXN1bHQsIG9wdGlvbnM/LmNsb3NlRGVsYXkpLFxuXHRcdH07XG5cblx0XHRjb25zdCBkZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblx0XHRjb25zdCBvcGVuID0gc2lnbmFsPGJvb2xlYW4+KHRydWUpO1xuXHRcdGNvbnN0IHN0YXRlID0gY29tcHV0ZWQ8QnJuRGlhbG9nU3RhdGU+KCgpID0+IChvcGVuKCkgPyAnb3BlbicgOiAnY2xvc2VkJykpO1xuXHRcdGNvbnN0IGRpYWxvZ0lkID0gZGlhbG9nU2VxdWVuY2UrKztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0Y29uc3QgY2RrRGlhbG9nUmVmID0gdGhpcy5fY2RrRGlhbG9nLm9wZW4oY29udGVudCwge1xuXHRcdFx0aWQ6IG9wdGlvbnM/LmlkID8/IGBicm4tZGlhbG9nLSR7ZGlhbG9nSWR9YCxcblx0XHRcdHJvbGU6IG9wdGlvbnM/LnJvbGUsXG5cdFx0XHR2aWV3Q29udGFpbmVyUmVmOiB2Y3IsXG5cdFx0XHR0ZW1wbGF0ZUNvbnRleHQ6ICgpID0+ICh7XG5cdFx0XHRcdCRpbXBsaWNpdDogY29udGV4dE9yRGF0YSxcblx0XHRcdH0pLFxuXHRcdFx0ZGF0YTogY29udGV4dE9yRGF0YSxcblx0XHRcdGhhc0JhY2tkcm9wOiBvcHRpb25zPy5oYXNCYWNrZHJvcCxcblx0XHRcdHBhbmVsQ2xhc3M6IGNzc0NsYXNzZXNUb0FycmF5KG9wdGlvbnM/LnBhbmVsQ2xhc3MpLFxuXHRcdFx0YmFja2Ryb3BDbGFzczogY3NzQ2xhc3Nlc1RvQXJyYXkob3B0aW9ucz8uYmFja2Ryb3BDbGFzcywgJ2JnLXRyYW5zcGFyZW50JyksXG5cdFx0XHRwb3NpdGlvblN0cmF0ZWd5LFxuXHRcdFx0c2Nyb2xsU3RyYXRlZ3k6IG9wdGlvbnM/LnNjcm9sbFN0cmF0ZWd5ID8/IHRoaXMuX3Nzbz8uYmxvY2soKSxcblx0XHRcdHJlc3RvcmVGb2N1czogb3B0aW9ucz8ucmVzdG9yZUZvY3VzLFxuXHRcdFx0ZGlzYWJsZUNsb3NlOiB0cnVlLFxuXHRcdFx0YXV0b0ZvY3VzOiBvcHRpb25zPy5hdXRvRm9jdXMgPz8gJ2ZpcnN0LXRhYmJhYmxlJyxcblx0XHRcdGFyaWFEZXNjcmliZWRCeTogb3B0aW9ucz8uYXJpYURlc2NyaWJlZEJ5ID8/IGBicm4tZGlhbG9nLWRlc2NyaXB0aW9uLSR7ZGlhbG9nSWR9YCxcblx0XHRcdGFyaWFMYWJlbGxlZEJ5OiBvcHRpb25zPy5hcmlhTGFiZWxsZWRCeSA/PyBgYnJuLWRpYWxvZy10aXRsZS0ke2RpYWxvZ0lkfWAsXG5cdFx0XHRhcmlhTGFiZWw6IG9wdGlvbnM/LmFyaWFMYWJlbCxcblx0XHRcdGFyaWFNb2RhbDogb3B0aW9ucz8uYXJpYU1vZGFsLFxuXHRcdFx0cHJvdmlkZXJzOiAoY2RrRGlhbG9nUmVmKSA9PiB7XG5cdFx0XHRcdGJybkRpYWxvZ1JlZiA9IG5ldyBCcm5EaWFsb2dSZWYoY2RrRGlhbG9nUmVmLCBvcGVuLCBzdGF0ZSwgZGlhbG9nSWQsIG9wdGlvbnMgYXMgQnJuRGlhbG9nT3B0aW9ucyk7XG5cblx0XHRcdFx0cnVuSW5JbmplY3Rpb25Db250ZXh0KHRoaXMuX2luamVjdG9yLCAoKSA9PiB7XG5cdFx0XHRcdFx0ZWZmZWN0UmVmID0gZWZmZWN0KCgpID0+IHtcblx0XHRcdFx0XHRcdGlmIChvdmVybGF5KSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShvdmVybGF5LCAnZGF0YS1zdGF0ZScsIHN0YXRlKCkpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0aWYgKGJhY2tkcm9wKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShiYWNrZHJvcCwgJ2RhdGEtc3RhdGUnLCBzdGF0ZSgpKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0Y29uc3QgcHJvdmlkZXJzOiBTdGF0aWNQcm92aWRlcltdID0gW1xuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHByb3ZpZGU6IEJybkRpYWxvZ1JlZixcblx0XHRcdFx0XHRcdHVzZVZhbHVlOiBicm5EaWFsb2dSZWYsXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XTtcblxuXHRcdFx0XHRpZiAob3B0aW9ucz8ucHJvdmlkZXJzKSB7XG5cdFx0XHRcdFx0aWYgKHR5cGVvZiBvcHRpb25zLnByb3ZpZGVycyA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRcdFx0cHJvdmlkZXJzLnB1c2goLi4ub3B0aW9ucy5wcm92aWRlcnMoKSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucy5wcm92aWRlcnMpKSB7XG5cdFx0XHRcdFx0XHRwcm92aWRlcnMucHVzaCguLi5vcHRpb25zLnByb3ZpZGVycyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIHByb3ZpZGVycztcblx0XHRcdH0sXG5cdFx0fSk7XG5cblx0XHRjb25zdCBvdmVybGF5ID0gY2RrRGlhbG9nUmVmLm92ZXJsYXlSZWYub3ZlcmxheUVsZW1lbnQ7XG5cdFx0Y29uc3QgYmFja2Ryb3AgPSBjZGtEaWFsb2dSZWYub3ZlcmxheVJlZi5iYWNrZHJvcEVsZW1lbnQ7XG5cblx0XHRpZiAob3B0aW9ucz8uY2xvc2VPbk91dHNpZGVQb2ludGVyRXZlbnRzKSB7XG5cdFx0XHRjZGtEaWFsb2dSZWYub3V0c2lkZVBvaW50ZXJFdmVudHMucGlwZSh0YWtlVW50aWwoZGVzdHJveWVkJCkpLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRcdGJybkRpYWxvZ1JlZi5jbG9zZSh1bmRlZmluZWQsIG9wdGlvbnM/LmNsb3NlRGVsYXkpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0aWYgKG9wdGlvbnM/LmNsb3NlT25CYWNrZHJvcENsaWNrKSB7XG5cdFx0XHRjZGtEaWFsb2dSZWYuYmFja2Ryb3BDbGljay5waXBlKHRha2VVbnRpbChkZXN0cm95ZWQkKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0YnJuRGlhbG9nUmVmLmNsb3NlKHVuZGVmaW5lZCwgb3B0aW9ucz8uY2xvc2VEZWxheSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoIW9wdGlvbnM/LmRpc2FibGVDbG9zZSkge1xuXHRcdFx0Y2RrRGlhbG9nUmVmLmtleWRvd25FdmVudHNcblx0XHRcdFx0LnBpcGUoXG5cdFx0XHRcdFx0ZmlsdGVyKChlKSA9PiBlLmtleSA9PT0gJ0VzY2FwZScpLFxuXHRcdFx0XHRcdHRha2VVbnRpbChkZXN0cm95ZWQkKSxcblx0XHRcdFx0KVxuXHRcdFx0XHQuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0XHRicm5EaWFsb2dSZWYuY2xvc2UodW5kZWZpbmVkLCBvcHRpb25zPy5jbG9zZURlbGF5KTtcblx0XHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0Y2RrRGlhbG9nUmVmLmNsb3NlZC5waXBlKHRha2VVbnRpbChkZXN0cm95ZWQkKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdGVmZmVjdFJlZj8uZGVzdHJveSgpO1xuXHRcdFx0ZGVzdHJveWVkJC5uZXh0KCk7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gYnJuRGlhbG9nUmVmO1xuXHR9XG59XG4iXX0=