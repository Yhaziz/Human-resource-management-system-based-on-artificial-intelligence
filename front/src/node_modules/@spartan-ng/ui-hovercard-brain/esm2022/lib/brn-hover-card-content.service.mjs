import { Overlay, OverlayPositionBuilder, } from '@angular/cdk/overlay';
import { TemplatePortal } from '@angular/cdk/portal';
import { Injectable, NgZone, TemplateRef, inject, signal, } from '@angular/core';
import { toSignal } from '@angular/core/rxjs-interop';
import { BehaviorSubject, Subject, filter, map, of, switchMap } from 'rxjs';
import { createHoverObservable } from './createHoverObservable';
import * as i0 from "@angular/core";
const topFirstPositions = [
    {
        originX: 'center',
        originY: 'top',
        overlayX: 'center',
        overlayY: 'bottom',
    },
    {
        originX: 'center',
        originY: 'bottom',
        overlayX: 'center',
        overlayY: 'top',
    },
];
const bottomFirstPositions = [
    {
        originX: 'center',
        originY: 'bottom',
        overlayX: 'center',
        overlayY: 'top',
    },
    {
        originX: 'center',
        originY: 'top',
        overlayX: 'center',
        overlayY: 'bottom',
    },
];
export class BrnHoverCardContentService {
    constructor() {
        this._overlay = inject(Overlay);
        this._zone = inject(NgZone);
        this._psBuilder = inject(OverlayPositionBuilder);
        this._content = signal(null);
        this._state = signal('closed');
        this._config = {};
        this._destroyed$ = new Subject();
        this._positionChangesObservables$ = new BehaviorSubject(undefined);
        this._overlayHoveredObservables$ = new BehaviorSubject(undefined);
        this.positionChanges$ = this._positionChangesObservables$.pipe(switchMap((positionChangeObservable) => (positionChangeObservable ? positionChangeObservable : of(undefined))), filter((change) => change !== undefined && change !== null));
        this.hovered$ = this._overlayHoveredObservables$.pipe(switchMap((overlayHoveredObservable) => (overlayHoveredObservable ? overlayHoveredObservable : of(false))));
        this.state = this._state.asReadonly();
        this.side = toSignal(this.positionChanges$.pipe(map((change) => 
        // todo: better translation or adjusting hlm to take that into account
        change.connectionPair.originY === 'center'
            ? change.connectionPair.originX === 'start'
                ? 'left'
                : 'right'
            : change.connectionPair.originY)), { initialValue: 'bottom' });
    }
    setConfig(config) {
        this._config = config;
        if (config['attachTo']) {
            this._positionStrategy = this._psBuilder
                .flexibleConnectedTo(config['attachTo'])
                .withPositions(config['attachPositions'] ?? config['align'] === 'top' ? topFirstPositions : bottomFirstPositions)
                .withDefaultOffsetY(config['sideOffset'] ?? 0);
            this._config = {
                ...this._config,
                positionStrategy: this._positionStrategy,
                scrollStrategy: this._overlay.scrollStrategies.reposition(),
            };
            this._positionChangesObservables$.next(this._positionStrategy.positionChanges);
        }
        this._overlayRef = this._overlay.create(this._config);
    }
    setContent(value, vcr) {
        this._content.set(new TemplatePortal(value instanceof TemplateRef ? value : value.template, vcr));
        if (!this._overlayRef) {
            this._overlayRef = this._overlay.create(this._config);
        }
    }
    setState(newState) {
        this._state.set(newState);
    }
    show() {
        const content = this._content();
        if (!content || !this._overlayRef)
            return;
        this._overlayRef?.detach();
        this._overlayRef?.attach(content);
        this._destroyed$ = new Subject();
        this._overlayHoveredObservables$.next(createHoverObservable(this._overlayRef.hostElement, this._zone, this._destroyed$));
    }
    hide() {
        this._overlayRef?.detach();
        this._destroyed$.next();
        this._destroyed$.complete();
        this._destroyed$ = new Subject();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnHoverCardContentService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnHoverCardContentService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnHoverCardContentService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJuLWhvdmVyLWNhcmQtY29udGVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy91aS9ob3Zlci1jYXJkL2JyYWluL3NyYy9saWIvYnJuLWhvdmVyLWNhcmQtY29udGVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixPQUFPLEVBQ1Asc0JBQXNCLEdBTXRCLE1BQU0sc0JBQXNCLENBQUM7QUFDOUIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFDTixVQUFVLEVBQ1YsTUFBTSxFQUNOLFdBQVcsRUFDWCxNQUFNLEVBQ04sTUFBTSxHQUlOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQW1CLE1BQU0sTUFBTSxDQUFDO0FBRTdGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOztBQVdoRSxNQUFNLGlCQUFpQixHQUF3QjtJQUM5QztRQUNDLE9BQU8sRUFBRSxRQUFRO1FBQ2pCLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLFFBQVE7UUFDbEIsUUFBUSxFQUFFLFFBQVE7S0FDbEI7SUFDRDtRQUNDLE9BQU8sRUFBRSxRQUFRO1FBQ2pCLE9BQU8sRUFBRSxRQUFRO1FBQ2pCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFFBQVEsRUFBRSxLQUFLO0tBQ2Y7Q0FDRCxDQUFDO0FBQ0YsTUFBTSxvQkFBb0IsR0FBd0I7SUFDakQ7UUFDQyxPQUFPLEVBQUUsUUFBUTtRQUNqQixPQUFPLEVBQUUsUUFBUTtRQUNqQixRQUFRLEVBQUUsUUFBUTtRQUNsQixRQUFRLEVBQUUsS0FBSztLQUNmO0lBQ0Q7UUFDQyxPQUFPLEVBQUUsUUFBUTtRQUNqQixPQUFPLEVBQUUsS0FBSztRQUNkLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFFBQVEsRUFBRSxRQUFRO0tBQ2xCO0NBQ0QsQ0FBQztBQUdGLE1BQU0sT0FBTywwQkFBMEI7SUFEdkM7UUFFa0IsYUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQixVQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZCLGVBQVUsR0FBRyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUU1QyxhQUFRLEdBQUcsTUFBTSxDQUFpQyxJQUFJLENBQUMsQ0FBQztRQUN4RCxXQUFNLEdBQUcsTUFBTSxDQUFvQixRQUFRLENBQUMsQ0FBQztRQUV0RCxZQUFPLEdBQXdCLEVBQUUsQ0FBQztRQUdsQyxnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFFbEMsaUNBQTRCLEdBQUcsSUFBSSxlQUFlLENBQ3pELFNBQVMsQ0FDVCxDQUFDO1FBQ00sZ0NBQTJCLEdBQUcsSUFBSSxlQUFlLENBQWtDLFNBQVMsQ0FBQyxDQUFDO1FBRXRGLHFCQUFnQixHQUErQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsSUFBSSxDQUNwSCxTQUFTLENBQUMsQ0FBQyx3QkFBd0IsRUFBRSxFQUFFLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQzlHLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBeUQsRUFBRSxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLElBQUksQ0FBQyxDQUNsSCxDQUFDO1FBQ2MsYUFBUSxHQUF3QixJQUFJLENBQUMsMkJBQTJCLENBQUMsSUFBSSxDQUNwRixTQUFTLENBQUMsQ0FBQyx3QkFBd0IsRUFBRSxFQUFFLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQzFHLENBQUM7UUFFYyxVQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNqQyxTQUFJLEdBQWdELFFBQVEsQ0FDM0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FDekIsR0FBRyxDQUFzRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQ25GLHNFQUFzRTtRQUN0RSxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sS0FBSyxRQUFRO1lBQ3pDLENBQUMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sS0FBSyxPQUFPO2dCQUMxQyxDQUFDLENBQUMsTUFBTTtnQkFDUixDQUFDLENBQUMsT0FBTztZQUNWLENBQUMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FDaEMsQ0FDRCxFQUNELEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxDQUMxQixDQUFDO0tBcURGO0lBbkRPLFNBQVMsQ0FBQyxNQUEyQjtRQUMzQyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsVUFBVTtpQkFDdEMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2lCQUN2QyxhQUFhLENBQ2IsTUFBTSxDQUFDLGlCQUFpQixDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLG9CQUFvQixDQUNqRztpQkFDQSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLE9BQU8sR0FBRztnQkFDZCxHQUFHLElBQUksQ0FBQyxPQUFPO2dCQUNmLGdCQUFnQixFQUFFLElBQUksQ0FBQyxpQkFBaUI7Z0JBQ3hDLGNBQWMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRTthQUMzRCxDQUFDO1lBQ0YsSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDaEYsQ0FBQztRQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTSxVQUFVLENBQUMsS0FBMEQsRUFBRSxHQUFxQjtRQUNsRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLGNBQWMsQ0FBVSxLQUFLLFlBQVksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUUzRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZELENBQUM7SUFDRixDQUFDO0lBRU0sUUFBUSxDQUFDLFFBQTJCO1FBQzFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTSxJQUFJO1FBQ1YsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVztZQUFFLE9BQU87UUFFMUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFFdkMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FDcEMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQ2pGLENBQUM7SUFDSCxDQUFDO0lBRU0sSUFBSTtRQUNWLElBQUksQ0FBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQUN4QyxDQUFDOzhHQTNGVywwQkFBMEI7a0hBQTFCLDBCQUEwQjs7MkZBQTFCLDBCQUEwQjtrQkFEdEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdE92ZXJsYXksXG5cdE92ZXJsYXlQb3NpdGlvbkJ1aWxkZXIsXG5cdHR5cGUgQ29ubmVjdGVkT3ZlcmxheVBvc2l0aW9uQ2hhbmdlLFxuXHR0eXBlIENvbm5lY3RlZFBvc2l0aW9uLFxuXHR0eXBlIEZsZXhpYmxlQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneSxcblx0dHlwZSBPdmVybGF5Q29uZmlnLFxuXHR0eXBlIE92ZXJsYXlSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQge1xuXHRJbmplY3RhYmxlLFxuXHROZ1pvbmUsXG5cdFRlbXBsYXRlUmVmLFxuXHRpbmplY3QsXG5cdHNpZ25hbCxcblx0dHlwZSBFbGVtZW50UmVmLFxuXHR0eXBlIFNpZ25hbCxcblx0dHlwZSBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHRvU2lnbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBTdWJqZWN0LCBmaWx0ZXIsIG1hcCwgb2YsIHN3aXRjaE1hcCwgdHlwZSBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgdHlwZSB7IEJybkhvdmVyQ2FyZENvbnRlbnREaXJlY3RpdmUgfSBmcm9tICcuL2Jybi1ob3Zlci1jYXJkLWNvbnRlbnQuZGlyZWN0aXZlJztcbmltcG9ydCB7IGNyZWF0ZUhvdmVyT2JzZXJ2YWJsZSB9IGZyb20gJy4vY3JlYXRlSG92ZXJPYnNlcnZhYmxlJztcblxuZXhwb3J0IHR5cGUgQnJuSG92ZXJDYXJkT3B0aW9ucyA9IFBhcnRpYWw8XG5cdHtcblx0XHRhdHRhY2hUbzogRWxlbWVudFJlZjtcblx0XHRhdHRhY2hQb3NpdGlvbnM6IENvbm5lY3RlZFBvc2l0aW9uW107XG5cdFx0YWxpZ246ICd0b3AnIHwgJ2JvdHRvbSc7XG5cdFx0c2lkZU9mZnNldDogbnVtYmVyO1xuXHR9ICYgT3ZlcmxheUNvbmZpZ1xuPjtcblxuY29uc3QgdG9wRmlyc3RQb3NpdGlvbnM6IENvbm5lY3RlZFBvc2l0aW9uW10gPSBbXG5cdHtcblx0XHRvcmlnaW5YOiAnY2VudGVyJyxcblx0XHRvcmlnaW5ZOiAndG9wJyxcblx0XHRvdmVybGF5WDogJ2NlbnRlcicsXG5cdFx0b3ZlcmxheVk6ICdib3R0b20nLFxuXHR9LFxuXHR7XG5cdFx0b3JpZ2luWDogJ2NlbnRlcicsXG5cdFx0b3JpZ2luWTogJ2JvdHRvbScsXG5cdFx0b3ZlcmxheVg6ICdjZW50ZXInLFxuXHRcdG92ZXJsYXlZOiAndG9wJyxcblx0fSxcbl07XG5jb25zdCBib3R0b21GaXJzdFBvc2l0aW9uczogQ29ubmVjdGVkUG9zaXRpb25bXSA9IFtcblx0e1xuXHRcdG9yaWdpblg6ICdjZW50ZXInLFxuXHRcdG9yaWdpblk6ICdib3R0b20nLFxuXHRcdG92ZXJsYXlYOiAnY2VudGVyJyxcblx0XHRvdmVybGF5WTogJ3RvcCcsXG5cdH0sXG5cdHtcblx0XHRvcmlnaW5YOiAnY2VudGVyJyxcblx0XHRvcmlnaW5ZOiAndG9wJyxcblx0XHRvdmVybGF5WDogJ2NlbnRlcicsXG5cdFx0b3ZlcmxheVk6ICdib3R0b20nLFxuXHR9LFxuXTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJybkhvdmVyQ2FyZENvbnRlbnRTZXJ2aWNlIHtcblx0cHJpdmF0ZSByZWFkb25seSBfb3ZlcmxheSA9IGluamVjdChPdmVybGF5KTtcblx0cHJpdmF0ZSByZWFkb25seSBfem9uZSA9IGluamVjdChOZ1pvbmUpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9wc0J1aWxkZXIgPSBpbmplY3QoT3ZlcmxheVBvc2l0aW9uQnVpbGRlcik7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfY29udGVudCA9IHNpZ25hbDxUZW1wbGF0ZVBvcnRhbDx1bmtub3duPiB8IG51bGw+KG51bGwpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9zdGF0ZSA9IHNpZ25hbDwnb3BlbicgfCAnY2xvc2VkJz4oJ2Nsb3NlZCcpO1xuXG5cdHByaXZhdGUgX2NvbmZpZzogQnJuSG92ZXJDYXJkT3B0aW9ucyA9IHt9O1xuXHRwcml2YXRlIF9vdmVybGF5UmVmPzogT3ZlcmxheVJlZjtcblx0cHJpdmF0ZSBfcG9zaXRpb25TdHJhdGVneT86IEZsZXhpYmxlQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneTtcblx0cHJpdmF0ZSBfZGVzdHJveWVkJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cblx0cHJpdmF0ZSBfcG9zaXRpb25DaGFuZ2VzT2JzZXJ2YWJsZXMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxPYnNlcnZhYmxlPENvbm5lY3RlZE92ZXJsYXlQb3NpdGlvbkNoYW5nZT4gfCB1bmRlZmluZWQ+KFxuXHRcdHVuZGVmaW5lZCxcblx0KTtcblx0cHJpdmF0ZSBfb3ZlcmxheUhvdmVyZWRPYnNlcnZhYmxlcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE9ic2VydmFibGU8Ym9vbGVhbj4gfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cblx0cHVibGljIHJlYWRvbmx5IHBvc2l0aW9uQ2hhbmdlcyQ6IE9ic2VydmFibGU8Q29ubmVjdGVkT3ZlcmxheVBvc2l0aW9uQ2hhbmdlPiA9IHRoaXMuX3Bvc2l0aW9uQ2hhbmdlc09ic2VydmFibGVzJC5waXBlKFxuXHRcdHN3aXRjaE1hcCgocG9zaXRpb25DaGFuZ2VPYnNlcnZhYmxlKSA9PiAocG9zaXRpb25DaGFuZ2VPYnNlcnZhYmxlID8gcG9zaXRpb25DaGFuZ2VPYnNlcnZhYmxlIDogb2YodW5kZWZpbmVkKSkpLFxuXHRcdGZpbHRlcigoY2hhbmdlKTogY2hhbmdlIGlzIE5vbk51bGxhYmxlPENvbm5lY3RlZE92ZXJsYXlQb3NpdGlvbkNoYW5nZT4gPT4gY2hhbmdlICE9PSB1bmRlZmluZWQgJiYgY2hhbmdlICE9PSBudWxsKSxcblx0KTtcblx0cHVibGljIHJlYWRvbmx5IGhvdmVyZWQkOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpcy5fb3ZlcmxheUhvdmVyZWRPYnNlcnZhYmxlcyQucGlwZShcblx0XHRzd2l0Y2hNYXAoKG92ZXJsYXlIb3ZlcmVkT2JzZXJ2YWJsZSkgPT4gKG92ZXJsYXlIb3ZlcmVkT2JzZXJ2YWJsZSA/IG92ZXJsYXlIb3ZlcmVkT2JzZXJ2YWJsZSA6IG9mKGZhbHNlKSkpLFxuXHQpO1xuXG5cdHB1YmxpYyByZWFkb25seSBzdGF0ZSA9IHRoaXMuX3N0YXRlLmFzUmVhZG9ubHkoKTtcblx0cHVibGljIHJlYWRvbmx5IHNpZGU6IFNpZ25hbDwndG9wJyB8ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3JpZ2h0Jz4gPSB0b1NpZ25hbChcblx0XHR0aGlzLnBvc2l0aW9uQ2hhbmdlcyQucGlwZShcblx0XHRcdG1hcDxDb25uZWN0ZWRPdmVybGF5UG9zaXRpb25DaGFuZ2UsICd0b3AnIHwgJ2JvdHRvbScgfCAnbGVmdCcgfCAncmlnaHQnPigoY2hhbmdlKSA9PlxuXHRcdFx0XHQvLyB0b2RvOiBiZXR0ZXIgdHJhbnNsYXRpb24gb3IgYWRqdXN0aW5nIGhsbSB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50XG5cdFx0XHRcdGNoYW5nZS5jb25uZWN0aW9uUGFpci5vcmlnaW5ZID09PSAnY2VudGVyJ1xuXHRcdFx0XHRcdD8gY2hhbmdlLmNvbm5lY3Rpb25QYWlyLm9yaWdpblggPT09ICdzdGFydCdcblx0XHRcdFx0XHRcdD8gJ2xlZnQnXG5cdFx0XHRcdFx0XHQ6ICdyaWdodCdcblx0XHRcdFx0XHQ6IGNoYW5nZS5jb25uZWN0aW9uUGFpci5vcmlnaW5ZLFxuXHRcdFx0KSxcblx0XHQpLFxuXHRcdHsgaW5pdGlhbFZhbHVlOiAnYm90dG9tJyB9LFxuXHQpO1xuXG5cdHB1YmxpYyBzZXRDb25maWcoY29uZmlnOiBCcm5Ib3ZlckNhcmRPcHRpb25zKSB7XG5cdFx0dGhpcy5fY29uZmlnID0gY29uZmlnO1xuXHRcdGlmIChjb25maWdbJ2F0dGFjaFRvJ10pIHtcblx0XHRcdHRoaXMuX3Bvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLl9wc0J1aWxkZXJcblx0XHRcdFx0LmZsZXhpYmxlQ29ubmVjdGVkVG8oY29uZmlnWydhdHRhY2hUbyddKVxuXHRcdFx0XHQud2l0aFBvc2l0aW9ucyhcblx0XHRcdFx0XHRjb25maWdbJ2F0dGFjaFBvc2l0aW9ucyddID8/IGNvbmZpZ1snYWxpZ24nXSA9PT0gJ3RvcCcgPyB0b3BGaXJzdFBvc2l0aW9ucyA6IGJvdHRvbUZpcnN0UG9zaXRpb25zLFxuXHRcdFx0XHQpXG5cdFx0XHRcdC53aXRoRGVmYXVsdE9mZnNldFkoY29uZmlnWydzaWRlT2Zmc2V0J10gPz8gMCk7XG5cdFx0XHR0aGlzLl9jb25maWcgPSB7XG5cdFx0XHRcdC4uLnRoaXMuX2NvbmZpZyxcblx0XHRcdFx0cG9zaXRpb25TdHJhdGVneTogdGhpcy5fcG9zaXRpb25TdHJhdGVneSxcblx0XHRcdFx0c2Nyb2xsU3RyYXRlZ3k6IHRoaXMuX292ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5yZXBvc2l0aW9uKCksXG5cdFx0XHR9O1xuXHRcdFx0dGhpcy5fcG9zaXRpb25DaGFuZ2VzT2JzZXJ2YWJsZXMkLm5leHQodGhpcy5fcG9zaXRpb25TdHJhdGVneS5wb3NpdGlvbkNoYW5nZXMpO1xuXHRcdH1cblx0XHR0aGlzLl9vdmVybGF5UmVmID0gdGhpcy5fb3ZlcmxheS5jcmVhdGUodGhpcy5fY29uZmlnKTtcblx0fVxuXG5cdHB1YmxpYyBzZXRDb250ZW50KHZhbHVlOiBUZW1wbGF0ZVJlZjx1bmtub3duPiB8IEJybkhvdmVyQ2FyZENvbnRlbnREaXJlY3RpdmUsIHZjcjogVmlld0NvbnRhaW5lclJlZikge1xuXHRcdHRoaXMuX2NvbnRlbnQuc2V0KG5ldyBUZW1wbGF0ZVBvcnRhbDx1bmtub3duPih2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmID8gdmFsdWUgOiB2YWx1ZS50ZW1wbGF0ZSwgdmNyKSk7XG5cblx0XHRpZiAoIXRoaXMuX292ZXJsYXlSZWYpIHtcblx0XHRcdHRoaXMuX292ZXJsYXlSZWYgPSB0aGlzLl9vdmVybGF5LmNyZWF0ZSh0aGlzLl9jb25maWcpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBzZXRTdGF0ZShuZXdTdGF0ZTogJ29wZW4nIHwgJ2Nsb3NlZCcpIHtcblx0XHR0aGlzLl9zdGF0ZS5zZXQobmV3U3RhdGUpO1xuXHR9XG5cblx0cHVibGljIHNob3coKSB7XG5cdFx0Y29uc3QgY29udGVudCA9IHRoaXMuX2NvbnRlbnQoKTtcblx0XHRpZiAoIWNvbnRlbnQgfHwgIXRoaXMuX292ZXJsYXlSZWYpIHJldHVybjtcblxuXHRcdHRoaXMuX292ZXJsYXlSZWY/LmRldGFjaCgpO1xuXHRcdHRoaXMuX292ZXJsYXlSZWY/LmF0dGFjaChjb250ZW50KTtcblxuXHRcdHRoaXMuX2Rlc3Ryb3llZCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG5cdFx0dGhpcy5fb3ZlcmxheUhvdmVyZWRPYnNlcnZhYmxlcyQubmV4dChcblx0XHRcdGNyZWF0ZUhvdmVyT2JzZXJ2YWJsZSh0aGlzLl9vdmVybGF5UmVmLmhvc3RFbGVtZW50LCB0aGlzLl96b25lLCB0aGlzLl9kZXN0cm95ZWQkKSxcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGhpZGUoKSB7XG5cdFx0dGhpcy5fb3ZlcmxheVJlZj8uZGV0YWNoKCk7XG5cdFx0dGhpcy5fZGVzdHJveWVkJC5uZXh0KCk7XG5cdFx0dGhpcy5fZGVzdHJveWVkJC5jb21wbGV0ZSgpO1xuXHRcdHRoaXMuX2Rlc3Ryb3llZCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXHR9XG59XG4iXX0=