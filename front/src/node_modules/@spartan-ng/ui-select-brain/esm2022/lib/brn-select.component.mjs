import { CdkListbox, CdkListboxModule } from '@angular/cdk/listbox';
import { CdkConnectedOverlay, OverlayModule, } from '@angular/cdk/overlay';
import { JsonPipe } from '@angular/common';
import { ChangeDetectionStrategy, Component, ContentChild, ContentChildren, EventEmitter, Input, Output, ViewChild, computed, inject, input, signal, } from '@angular/core';
import { takeUntilDestroyed, toObservable, toSignal } from '@angular/core/rxjs-interop';
import { NgControl } from '@angular/forms';
import { provideExposedSideProviderExisting, provideExposesStateProviderExisting, } from '@spartan-ng/ui-core';
import { BrnLabelDirective } from '@spartan-ng/ui-label-brain';
import { Subject, delay, map, of, skip, switchMap } from 'rxjs';
import { BrnSelectContentComponent } from './brn-select-content.component';
import { BrnSelectOptionDirective } from './brn-select-option.directive';
import { BrnSelectTriggerDirective } from './brn-select-trigger.directive';
import { BrnSelectService } from './brn-select.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
let nextId = 0;
export class BrnSelectComponent {
    // eslint-disable-next-line @angular-eslint/no-input-rename
    set multiple(multiple) {
        this._selectService.state.update((state) => ({ ...state, multiple }));
    }
    // eslint-disable-next-line @angular-eslint/no-input-rename
    set placeholder(placeholder) {
        this._selectService.state.update((state) => ({ ...state, placeholder }));
    }
    // eslint-disable-next-line @angular-eslint/no-input-rename
    set disabled(disabled) {
        this._selectService.state.update((state) => ({ ...state, disabled }));
    }
    constructor() {
        this._selectService = inject(BrnSelectService);
        this.triggerWidth = this._selectService.triggerWidth;
        this._multiple = this._selectService.multiple;
        this._placeholder = this._selectService.placeholder;
        this._disabled = this._selectService.disabled;
        this.dir = input('ltr');
        this.openedChange = new EventEmitter();
        this.closeDelay = input(100);
        this.isExpanded = this._selectService.isExpanded;
        this._delayedExpanded = toSignal(toObservable(this.isExpanded).pipe(switchMap((expanded) => (!expanded ? of(expanded).pipe(delay(this.closeDelay())) : of(expanded))), takeUntilDestroyed()), { initialValue: false });
        this.state = computed(() => (this.isExpanded() ? 'open' : 'closed'));
        this._positionChanges$ = new Subject();
        this.side = toSignal(this._positionChanges$.pipe(map((change) => 
        // todo: better translation or adjusting hlm to take that into account
        change.connectionPair.originY === 'center'
            ? change.connectionPair.originX === 'start'
                ? 'left'
                : 'right'
            : change.connectionPair.originY)), { initialValue: 'bottom' });
        this.backupLabelId = computed(() => this._selectService.labelId());
        this.labelProvided = signal(false);
        this.ngControl = inject(NgControl, { optional: true, self: true });
        // eslint-disable-next-line @typescript-eslint/no-empty-function
        this._onChange = () => { };
        // eslint-disable-next-line @typescript-eslint/no-empty-function
        this._onTouched = () => { };
        /*
         * This position config ensures that the top "start" corner of the overlay
         * is aligned with with the top "start" of the origin by default (overlapping
         * the trigger completely). If the panel cannot fit below the trigger, it
         * will fall back to a position above the trigger.
         */
        this._positions = [
            {
                originX: 'start',
                originY: 'bottom',
                overlayX: 'start',
                overlayY: 'top',
            },
            {
                originX: 'end',
                originY: 'bottom',
                overlayX: 'end',
                overlayY: 'top',
            },
            {
                originX: 'start',
                originY: 'top',
                overlayX: 'start',
                overlayY: 'bottom',
            },
            {
                originX: 'end',
                originY: 'top',
                overlayX: 'end',
                overlayY: 'bottom',
            },
        ];
        this._selectService.state.update((state) => ({
            ...state,
            id: `brn-select-${nextId++}`,
        }));
        if (this.ngControl != null) {
            this.ngControl.valueAccessor = this;
        }
        // Watch for Listbox Selection Changes to trigger Collapse
        this._selectService.listBoxValueChangeEvent$.pipe(takeUntilDestroyed()).subscribe(() => {
            if (!this._multiple()) {
                this.close();
            }
        });
        toObservable(this._selectService.value)
            // skipping first else ngcontrol always starts off as dirty and triggering value change on init value
            .pipe(takeUntilDestroyed(), skip(1))
            .subscribe((value) => this._onChange(value || null));
        toObservable(this.dir)
            .pipe(takeUntilDestroyed())
            .subscribe(() => this._selectService.state.update((state) => ({
            ...state,
            dir: this.dir(),
        })));
    }
    ngAfterContentInit() {
        // Check if Label Directive Provided and pass to service
        if (this.selectLabel) {
            this.labelProvided.set(true);
            this._selectService.state.update((state) => ({
                ...state,
                labelId: this.selectLabel.id,
                dir: this.dir(),
            }));
        }
        else if (this._placeholder()) {
            this._selectService.state.update((state) => ({
                ...state,
                labelId: `${state.id}--label`,
                dir: this.dir(),
            }));
        }
    }
    toggle() {
        if (this.isExpanded()) {
            this.close();
        }
        else {
            this.open();
        }
    }
    open() {
        if (!this._canOpen())
            return;
        this._selectService.state.update((state) => ({
            ...state,
            isExpanded: true,
        }));
        this.openedChange.next(true);
        this._moveFocusToCDKList();
    }
    close() {
        if (!this.isExpanded())
            return;
        if (this._selectService.selectTrigger) {
            this._selectService.selectTrigger.focus();
        }
        this.openedChange.next(false);
        this._selectService.state.update((state) => ({
            ...state,
            isExpanded: false,
        }));
        this._onTouched();
    }
    _canOpen() {
        return !this.isExpanded() && !this._disabled() && this.options?.length > 0;
    }
    _moveFocusToCDKList() {
        setTimeout(() => this.selectContent.focusList());
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    writeValue(value) {
        this._selectService.setInitialSelectedOptions(value);
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    registerOnChange(fn) {
        this._onChange = fn;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    registerOnTouched(fn) {
        this._onTouched = fn;
    }
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnSelectComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.3.5", type: BrnSelectComponent, isStandalone: true, selector: "brn-select, hlm-select", inputs: { multiple: { classPropertyName: "multiple", publicName: "multiple", isSignal: false, isRequired: false, transformFunction: null }, placeholder: { classPropertyName: "placeholder", publicName: "placeholder", isSignal: false, isRequired: false, transformFunction: null }, disabled: { classPropertyName: "disabled", publicName: "disabled", isSignal: false, isRequired: false, transformFunction: null }, dir: { classPropertyName: "dir", publicName: "dir", isSignal: true, isRequired: false, transformFunction: null }, closeDelay: { classPropertyName: "closeDelay", publicName: "closeDelay", isSignal: true, isRequired: false, transformFunction: null } }, outputs: { openedChange: "openedChange" }, providers: [
            BrnSelectService,
            CdkListbox,
            provideExposedSideProviderExisting(() => BrnSelectComponent),
            provideExposesStateProviderExisting(() => BrnSelectComponent),
        ], queries: [{ propertyName: "selectLabel", first: true, predicate: BrnLabelDirective }, { propertyName: "selectContent", first: true, predicate: BrnSelectContentComponent, descendants: true }, { propertyName: "options", predicate: BrnSelectOptionDirective, descendants: true }], viewQueries: [{ propertyName: "_overlayDir", first: true, predicate: CdkConnectedOverlay, descendants: true }], ngImport: i0, template: `
		@if (!labelProvided() && _placeholder()) {
			<label class="hidden" [attr.id]="backupLabelId()">{{ _placeholder() }}</label>
		} @else {
			<ng-content select="label[hlmLabel],label[brnLabel]" />
		}

		<div cdk-overlay-origin (click)="toggle()" #trigger="cdkOverlayOrigin">
			<ng-content select="hlm-select-trigger,[brnSelectTrigger]" />
		</div>
		<ng-template
			cdk-connected-overlay
			cdkConnectedOverlayLockPosition
			cdkConnectedOverlayHasBackdrop
			cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
			[cdkConnectedOverlayOrigin]="trigger"
			[cdkConnectedOverlayOpen]="_delayedExpanded()"
			[cdkConnectedOverlayPositions]="_positions"
			[cdkConnectedOverlayWidth]="triggerWidth() > 0 ? triggerWidth() : 'auto'"
			(backdropClick)="close()"
			(detach)="close()"
			(positionChange)="_positionChanges$.next($event)"
		>
			<ng-content />
		</ng-template>
	`, isInline: true, dependencies: [{ kind: "ngmodule", type: OverlayModule }, { kind: "directive", type: i1.CdkConnectedOverlay, selector: "[cdk-connected-overlay], [connected-overlay], [cdkConnectedOverlay]", inputs: ["cdkConnectedOverlayOrigin", "cdkConnectedOverlayPositions", "cdkConnectedOverlayPositionStrategy", "cdkConnectedOverlayOffsetX", "cdkConnectedOverlayOffsetY", "cdkConnectedOverlayWidth", "cdkConnectedOverlayHeight", "cdkConnectedOverlayMinWidth", "cdkConnectedOverlayMinHeight", "cdkConnectedOverlayBackdropClass", "cdkConnectedOverlayPanelClass", "cdkConnectedOverlayViewportMargin", "cdkConnectedOverlayScrollStrategy", "cdkConnectedOverlayOpen", "cdkConnectedOverlayDisableClose", "cdkConnectedOverlayTransformOriginOn", "cdkConnectedOverlayHasBackdrop", "cdkConnectedOverlayLockPosition", "cdkConnectedOverlayFlexibleDimensions", "cdkConnectedOverlayGrowAfterOpen", "cdkConnectedOverlayPush", "cdkConnectedOverlayDisposeOnNavigation"], outputs: ["backdropClick", "positionChange", "attach", "detach", "overlayKeydown", "overlayOutsideClick"], exportAs: ["cdkConnectedOverlay"] }, { kind: "directive", type: i1.CdkOverlayOrigin, selector: "[cdk-overlay-origin], [overlay-origin], [cdkOverlayOrigin]", exportAs: ["cdkOverlayOrigin"] }, { kind: "ngmodule", type: CdkListboxModule }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnSelectComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'brn-select, hlm-select',
                    standalone: true,
                    imports: [OverlayModule, BrnSelectTriggerDirective, CdkListboxModule, JsonPipe],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: [
                        BrnSelectService,
                        CdkListbox,
                        provideExposedSideProviderExisting(() => BrnSelectComponent),
                        provideExposesStateProviderExisting(() => BrnSelectComponent),
                    ],
                    template: `
		@if (!labelProvided() && _placeholder()) {
			<label class="hidden" [attr.id]="backupLabelId()">{{ _placeholder() }}</label>
		} @else {
			<ng-content select="label[hlmLabel],label[brnLabel]" />
		}

		<div cdk-overlay-origin (click)="toggle()" #trigger="cdkOverlayOrigin">
			<ng-content select="hlm-select-trigger,[brnSelectTrigger]" />
		</div>
		<ng-template
			cdk-connected-overlay
			cdkConnectedOverlayLockPosition
			cdkConnectedOverlayHasBackdrop
			cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
			[cdkConnectedOverlayOrigin]="trigger"
			[cdkConnectedOverlayOpen]="_delayedExpanded()"
			[cdkConnectedOverlayPositions]="_positions"
			[cdkConnectedOverlayWidth]="triggerWidth() > 0 ? triggerWidth() : 'auto'"
			(backdropClick)="close()"
			(detach)="close()"
			(positionChange)="_positionChanges$.next($event)"
		>
			<ng-content />
		</ng-template>
	`,
                }]
        }], ctorParameters: () => [], propDecorators: { multiple: [{
                type: Input,
                args: [{ alias: 'multiple' }]
            }], placeholder: [{
                type: Input,
                args: [{ alias: 'placeholder' }]
            }], disabled: [{
                type: Input,
                args: [{ alias: 'disabled' }]
            }], selectLabel: [{
                type: ContentChild,
                args: [BrnLabelDirective, { descendants: false }]
            }], selectContent: [{
                type: ContentChild,
                args: [BrnSelectContentComponent]
            }], options: [{
                type: ContentChildren,
                args: [BrnSelectOptionDirective, { descendants: true }]
            }], _overlayDir: [{
                type: ViewChild,
                args: [CdkConnectedOverlay]
            }], openedChange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJuLXNlbGVjdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3VpL3NlbGVjdC9icmFpbi9zcmMvbGliL2Jybi1zZWxlY3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwRSxPQUFPLEVBQ04sbUJBQW1CLEVBQ25CLGFBQWEsR0FHYixNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQ04sdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxZQUFZLEVBQ1osZUFBZSxFQUNmLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxRQUFRLEVBQ1IsTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEdBSU4sTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RixPQUFPLEVBQUUsU0FBUyxFQUE2QixNQUFNLGdCQUFnQixDQUFDO0FBQ3RFLE9BQU8sRUFDTixrQ0FBa0MsRUFDbEMsbUNBQW1DLEdBR25DLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzNFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSx5QkFBeUIsRUFB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LEVBQUUsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFO2dCQUk3QyxhQUFhO3NCQUR0QixZQUFZO3VCQUFDLHlCQUF5QjtnQkFHN0IsT0FBTztzQkFEaEIsZUFBZTt1QkFBQyx3QkFBd0IsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUU7Z0JBSXRELFdBQVc7c0JBRHBCLFNBQVM7dUJBQUMsbUJBQW1CO2dCQUk5QixZQUFZO3NCQURYLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZGtMaXN0Ym94LCBDZGtMaXN0Ym94TW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2xpc3Rib3gnO1xuaW1wb3J0IHtcblx0Q2RrQ29ubmVjdGVkT3ZlcmxheSxcblx0T3ZlcmxheU1vZHVsZSxcblx0dHlwZSBDb25uZWN0ZWRPdmVybGF5UG9zaXRpb25DaGFuZ2UsXG5cdHR5cGUgQ29ubmVjdGVkUG9zaXRpb24sXG59IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IEpzb25QaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG5cdENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuXHRDb21wb25lbnQsXG5cdENvbnRlbnRDaGlsZCxcblx0Q29udGVudENoaWxkcmVuLFxuXHRFdmVudEVtaXR0ZXIsXG5cdElucHV0LFxuXHRPdXRwdXQsXG5cdFZpZXdDaGlsZCxcblx0Y29tcHV0ZWQsXG5cdGluamVjdCxcblx0aW5wdXQsXG5cdHNpZ25hbCxcblx0dHlwZSBBZnRlckNvbnRlbnRJbml0LFxuXHR0eXBlIFF1ZXJ5TGlzdCxcblx0dHlwZSBTaWduYWwsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdGFrZVVudGlsRGVzdHJveWVkLCB0b09ic2VydmFibGUsIHRvU2lnbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnO1xuaW1wb3J0IHsgTmdDb250cm9sLCB0eXBlIENvbnRyb2xWYWx1ZUFjY2Vzc29yIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtcblx0cHJvdmlkZUV4cG9zZWRTaWRlUHJvdmlkZXJFeGlzdGluZyxcblx0cHJvdmlkZUV4cG9zZXNTdGF0ZVByb3ZpZGVyRXhpc3RpbmcsXG5cdHR5cGUgRXhwb3Nlc1NpZGUsXG5cdHR5cGUgRXhwb3Nlc1N0YXRlLFxufSBmcm9tICdAc3BhcnRhbi1uZy91aS1jb3JlJztcbmltcG9ydCB7IEJybkxhYmVsRGlyZWN0aXZlIH0gZnJvbSAnQHNwYXJ0YW4tbmcvdWktbGFiZWwtYnJhaW4nO1xuaW1wb3J0IHsgU3ViamVjdCwgZGVsYXksIG1hcCwgb2YsIHNraXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQnJuU2VsZWN0Q29udGVudENvbXBvbmVudCB9IGZyb20gJy4vYnJuLXNlbGVjdC1jb250ZW50LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBCcm5TZWxlY3RPcHRpb25EaXJlY3RpdmUgfSBmcm9tICcuL2Jybi1zZWxlY3Qtb3B0aW9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBCcm5TZWxlY3RUcmlnZ2VyRGlyZWN0aXZlIH0gZnJvbSAnLi9icm4tc2VsZWN0LXRyaWdnZXIuZGlyZWN0aXZlJztcbmltcG9ydCB7IEJyblNlbGVjdFNlcnZpY2UgfSBmcm9tICcuL2Jybi1zZWxlY3Quc2VydmljZSc7XG5cbmV4cG9ydCB0eXBlIEJyblJlYWREaXJlY3Rpb24gPSAnbHRyJyB8ICdydGwnO1xuXG5sZXQgbmV4dElkID0gMDtcblxuQENvbXBvbmVudCh7XG5cdHNlbGVjdG9yOiAnYnJuLXNlbGVjdCwgaGxtLXNlbGVjdCcsXG5cdHN0YW5kYWxvbmU6IHRydWUsXG5cdGltcG9ydHM6IFtPdmVybGF5TW9kdWxlLCBCcm5TZWxlY3RUcmlnZ2VyRGlyZWN0aXZlLCBDZGtMaXN0Ym94TW9kdWxlLCBKc29uUGlwZV0sXG5cdGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuXHRwcm92aWRlcnM6IFtcblx0XHRCcm5TZWxlY3RTZXJ2aWNlLFxuXHRcdENka0xpc3Rib3gsXG5cdFx0cHJvdmlkZUV4cG9zZWRTaWRlUHJvdmlkZXJFeGlzdGluZygoKSA9PiBCcm5TZWxlY3RDb21wb25lbnQpLFxuXHRcdHByb3ZpZGVFeHBvc2VzU3RhdGVQcm92aWRlckV4aXN0aW5nKCgpID0+IEJyblNlbGVjdENvbXBvbmVudCksXG5cdF0sXG5cdHRlbXBsYXRlOiBgXG5cdFx0QGlmICghbGFiZWxQcm92aWRlZCgpICYmIF9wbGFjZWhvbGRlcigpKSB7XG5cdFx0XHQ8bGFiZWwgY2xhc3M9XCJoaWRkZW5cIiBbYXR0ci5pZF09XCJiYWNrdXBMYWJlbElkKClcIj57eyBfcGxhY2Vob2xkZXIoKSB9fTwvbGFiZWw+XG5cdFx0fSBAZWxzZSB7XG5cdFx0XHQ8bmctY29udGVudCBzZWxlY3Q9XCJsYWJlbFtobG1MYWJlbF0sbGFiZWxbYnJuTGFiZWxdXCIgLz5cblx0XHR9XG5cblx0XHQ8ZGl2IGNkay1vdmVybGF5LW9yaWdpbiAoY2xpY2spPVwidG9nZ2xlKClcIiAjdHJpZ2dlcj1cImNka092ZXJsYXlPcmlnaW5cIj5cblx0XHRcdDxuZy1jb250ZW50IHNlbGVjdD1cImhsbS1zZWxlY3QtdHJpZ2dlcixbYnJuU2VsZWN0VHJpZ2dlcl1cIiAvPlxuXHRcdDwvZGl2PlxuXHRcdDxuZy10ZW1wbGF0ZVxuXHRcdFx0Y2RrLWNvbm5lY3RlZC1vdmVybGF5XG5cdFx0XHRjZGtDb25uZWN0ZWRPdmVybGF5TG9ja1Bvc2l0aW9uXG5cdFx0XHRjZGtDb25uZWN0ZWRPdmVybGF5SGFzQmFja2Ryb3Bcblx0XHRcdGNka0Nvbm5lY3RlZE92ZXJsYXlCYWNrZHJvcENsYXNzPVwiY2RrLW92ZXJsYXktdHJhbnNwYXJlbnQtYmFja2Ryb3BcIlxuXHRcdFx0W2Nka0Nvbm5lY3RlZE92ZXJsYXlPcmlnaW5dPVwidHJpZ2dlclwiXG5cdFx0XHRbY2RrQ29ubmVjdGVkT3ZlcmxheU9wZW5dPVwiX2RlbGF5ZWRFeHBhbmRlZCgpXCJcblx0XHRcdFtjZGtDb25uZWN0ZWRPdmVybGF5UG9zaXRpb25zXT1cIl9wb3NpdGlvbnNcIlxuXHRcdFx0W2Nka0Nvbm5lY3RlZE92ZXJsYXlXaWR0aF09XCJ0cmlnZ2VyV2lkdGgoKSA+IDAgPyB0cmlnZ2VyV2lkdGgoKSA6ICdhdXRvJ1wiXG5cdFx0XHQoYmFja2Ryb3BDbGljayk9XCJjbG9zZSgpXCJcblx0XHRcdChkZXRhY2gpPVwiY2xvc2UoKVwiXG5cdFx0XHQocG9zaXRpb25DaGFuZ2UpPVwiX3Bvc2l0aW9uQ2hhbmdlcyQubmV4dCgkZXZlbnQpXCJcblx0XHQ+XG5cdFx0XHQ8bmctY29udGVudCAvPlxuXHRcdDwvbmctdGVtcGxhdGU+XG5cdGAsXG59KVxuZXhwb3J0IGNsYXNzIEJyblNlbGVjdENvbXBvbmVudCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBBZnRlckNvbnRlbnRJbml0LCBFeHBvc2VzU2lkZSwgRXhwb3Nlc1N0YXRlIHtcblx0cHJpdmF0ZSByZWFkb25seSBfc2VsZWN0U2VydmljZSA9IGluamVjdChCcm5TZWxlY3RTZXJ2aWNlKTtcblxuXHRwdWJsaWMgcmVhZG9ubHkgdHJpZ2dlcldpZHRoID0gdGhpcy5fc2VsZWN0U2VydmljZS50cmlnZ2VyV2lkdGg7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcblx0QElucHV0KHsgYWxpYXM6ICdtdWx0aXBsZScgfSlcblx0c2V0IG11bHRpcGxlKG11bHRpcGxlOiBib29sZWFuKSB7XG5cdFx0dGhpcy5fc2VsZWN0U2VydmljZS5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoeyAuLi5zdGF0ZSwgbXVsdGlwbGUgfSkpO1xuXHR9XG5cdHByb3RlY3RlZCByZWFkb25seSBfbXVsdGlwbGUgPSB0aGlzLl9zZWxlY3RTZXJ2aWNlLm11bHRpcGxlO1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG5cdEBJbnB1dCh7IGFsaWFzOiAncGxhY2Vob2xkZXInIH0pXG5cdHNldCBwbGFjZWhvbGRlcihwbGFjZWhvbGRlcjogc3RyaW5nKSB7XG5cdFx0dGhpcy5fc2VsZWN0U2VydmljZS5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoeyAuLi5zdGF0ZSwgcGxhY2Vob2xkZXIgfSkpO1xuXHR9XG5cdHByb3RlY3RlZCByZWFkb25seSBfcGxhY2Vob2xkZXIgPSB0aGlzLl9zZWxlY3RTZXJ2aWNlLnBsYWNlaG9sZGVyO1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG5cdEBJbnB1dCh7IGFsaWFzOiAnZGlzYWJsZWQnIH0pXG5cdHNldCBkaXNhYmxlZChkaXNhYmxlZDogYm9vbGVhbikge1xuXHRcdHRoaXMuX3NlbGVjdFNlcnZpY2Uuc3RhdGUudXBkYXRlKChzdGF0ZSkgPT4gKHsgLi4uc3RhdGUsIGRpc2FibGVkIH0pKTtcblx0fVxuXHRwcm90ZWN0ZWQgcmVhZG9ubHkgX2Rpc2FibGVkID0gdGhpcy5fc2VsZWN0U2VydmljZS5kaXNhYmxlZDtcblxuXHRwdWJsaWMgcmVhZG9ubHkgZGlyID0gaW5wdXQ8QnJuUmVhZERpcmVjdGlvbj4oJ2x0cicpO1xuXG5cdEBDb250ZW50Q2hpbGQoQnJuTGFiZWxEaXJlY3RpdmUsIHsgZGVzY2VuZGFudHM6IGZhbHNlIH0pXG5cdHByb3RlY3RlZCBzZWxlY3RMYWJlbCE6IEJybkxhYmVsRGlyZWN0aXZlO1xuXHQvKiogT3ZlcmxheSBwYW5lIGNvbnRhaW5pbmcgdGhlIG9wdGlvbnMuICovXG5cdEBDb250ZW50Q2hpbGQoQnJuU2VsZWN0Q29udGVudENvbXBvbmVudClcblx0cHJvdGVjdGVkIHNlbGVjdENvbnRlbnQhOiBCcm5TZWxlY3RDb250ZW50Q29tcG9uZW50O1xuXHRAQ29udGVudENoaWxkcmVuKEJyblNlbGVjdE9wdGlvbkRpcmVjdGl2ZSwgeyBkZXNjZW5kYW50czogdHJ1ZSB9KVxuXHRwcm90ZWN0ZWQgb3B0aW9ucyE6IFF1ZXJ5TGlzdDxCcm5TZWxlY3RPcHRpb25EaXJlY3RpdmU+O1xuXHQvKiogT3ZlcmxheSBwYW5lIGNvbnRhaW5pbmcgdGhlIG9wdGlvbnMuICovXG5cdEBWaWV3Q2hpbGQoQ2RrQ29ubmVjdGVkT3ZlcmxheSlcblx0cHJvdGVjdGVkIF9vdmVybGF5RGlyITogQ2RrQ29ubmVjdGVkT3ZlcmxheTtcblxuXHRAT3V0cHV0KClcblx0b3BlbmVkQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuXG5cdHB1YmxpYyByZWFkb25seSBjbG9zZURlbGF5ID0gaW5wdXQ8bnVtYmVyPigxMDApO1xuXHRwdWJsaWMgcmVhZG9ubHkgaXNFeHBhbmRlZCA9IHRoaXMuX3NlbGVjdFNlcnZpY2UuaXNFeHBhbmRlZDtcblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9kZWxheWVkRXhwYW5kZWQgPSB0b1NpZ25hbChcblx0XHR0b09ic2VydmFibGUodGhpcy5pc0V4cGFuZGVkKS5waXBlKFxuXHRcdFx0c3dpdGNoTWFwKChleHBhbmRlZCkgPT4gKCFleHBhbmRlZCA/IG9mKGV4cGFuZGVkKS5waXBlKGRlbGF5KHRoaXMuY2xvc2VEZWxheSgpKSkgOiBvZihleHBhbmRlZCkpKSxcblx0XHRcdHRha2VVbnRpbERlc3Ryb3llZCgpLFxuXHRcdCksXG5cdFx0eyBpbml0aWFsVmFsdWU6IGZhbHNlIH0sXG5cdCk7XG5cdHB1YmxpYyByZWFkb25seSBzdGF0ZSA9IGNvbXB1dGVkKCgpID0+ICh0aGlzLmlzRXhwYW5kZWQoKSA/ICdvcGVuJyA6ICdjbG9zZWQnKSk7XG5cblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9wb3NpdGlvbkNoYW5nZXMkID0gbmV3IFN1YmplY3Q8Q29ubmVjdGVkT3ZlcmxheVBvc2l0aW9uQ2hhbmdlPigpO1xuXHRwdWJsaWMgcmVhZG9ubHkgc2lkZTogU2lnbmFsPCd0b3AnIHwgJ2JvdHRvbScgfCAnbGVmdCcgfCAncmlnaHQnPiA9IHRvU2lnbmFsKFxuXHRcdHRoaXMuX3Bvc2l0aW9uQ2hhbmdlcyQucGlwZShcblx0XHRcdG1hcDxDb25uZWN0ZWRPdmVybGF5UG9zaXRpb25DaGFuZ2UsICd0b3AnIHwgJ2JvdHRvbScgfCAnbGVmdCcgfCAncmlnaHQnPigoY2hhbmdlKSA9PlxuXHRcdFx0XHQvLyB0b2RvOiBiZXR0ZXIgdHJhbnNsYXRpb24gb3IgYWRqdXN0aW5nIGhsbSB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50XG5cdFx0XHRcdGNoYW5nZS5jb25uZWN0aW9uUGFpci5vcmlnaW5ZID09PSAnY2VudGVyJ1xuXHRcdFx0XHRcdD8gY2hhbmdlLmNvbm5lY3Rpb25QYWlyLm9yaWdpblggPT09ICdzdGFydCdcblx0XHRcdFx0XHRcdD8gJ2xlZnQnXG5cdFx0XHRcdFx0XHQ6ICdyaWdodCdcblx0XHRcdFx0XHQ6IGNoYW5nZS5jb25uZWN0aW9uUGFpci5vcmlnaW5ZLFxuXHRcdFx0KSxcblx0XHQpLFxuXHRcdHsgaW5pdGlhbFZhbHVlOiAnYm90dG9tJyB9LFxuXHQpO1xuXG5cdHB1YmxpYyByZWFkb25seSBiYWNrdXBMYWJlbElkID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5fc2VsZWN0U2VydmljZS5sYWJlbElkKCkpO1xuXHRwdWJsaWMgcmVhZG9ubHkgbGFiZWxQcm92aWRlZCA9IHNpZ25hbChmYWxzZSk7XG5cblx0cHVibGljIHJlYWRvbmx5IG5nQ29udHJvbCA9IGluamVjdChOZ0NvbnRyb2wsIHsgb3B0aW9uYWw6IHRydWUsIHNlbGY6IHRydWUgfSk7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuXHRwcml2YXRlIF9vbkNoYW5nZTogKHZhbHVlOiB1bmtub3duKSA9PiB2b2lkID0gKCkgPT4ge307XG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb25cblx0cHJpdmF0ZSBfb25Ub3VjaGVkID0gKCkgPT4ge307XG5cblx0Lypcblx0ICogVGhpcyBwb3NpdGlvbiBjb25maWcgZW5zdXJlcyB0aGF0IHRoZSB0b3AgXCJzdGFydFwiIGNvcm5lciBvZiB0aGUgb3ZlcmxheVxuXHQgKiBpcyBhbGlnbmVkIHdpdGggd2l0aCB0aGUgdG9wIFwic3RhcnRcIiBvZiB0aGUgb3JpZ2luIGJ5IGRlZmF1bHQgKG92ZXJsYXBwaW5nXG5cdCAqIHRoZSB0cmlnZ2VyIGNvbXBsZXRlbHkpLiBJZiB0aGUgcGFuZWwgY2Fubm90IGZpdCBiZWxvdyB0aGUgdHJpZ2dlciwgaXRcblx0ICogd2lsbCBmYWxsIGJhY2sgdG8gYSBwb3NpdGlvbiBhYm92ZSB0aGUgdHJpZ2dlci5cblx0ICovXG5cdHByb3RlY3RlZCBfcG9zaXRpb25zOiBDb25uZWN0ZWRQb3NpdGlvbltdID0gW1xuXHRcdHtcblx0XHRcdG9yaWdpblg6ICdzdGFydCcsXG5cdFx0XHRvcmlnaW5ZOiAnYm90dG9tJyxcblx0XHRcdG92ZXJsYXlYOiAnc3RhcnQnLFxuXHRcdFx0b3ZlcmxheVk6ICd0b3AnLFxuXHRcdH0sXG5cdFx0e1xuXHRcdFx0b3JpZ2luWDogJ2VuZCcsXG5cdFx0XHRvcmlnaW5ZOiAnYm90dG9tJyxcblx0XHRcdG92ZXJsYXlYOiAnZW5kJyxcblx0XHRcdG92ZXJsYXlZOiAndG9wJyxcblx0XHR9LFxuXHRcdHtcblx0XHRcdG9yaWdpblg6ICdzdGFydCcsXG5cdFx0XHRvcmlnaW5ZOiAndG9wJyxcblx0XHRcdG92ZXJsYXlYOiAnc3RhcnQnLFxuXHRcdFx0b3ZlcmxheVk6ICdib3R0b20nLFxuXHRcdH0sXG5cdFx0e1xuXHRcdFx0b3JpZ2luWDogJ2VuZCcsXG5cdFx0XHRvcmlnaW5ZOiAndG9wJyxcblx0XHRcdG92ZXJsYXlYOiAnZW5kJyxcblx0XHRcdG92ZXJsYXlZOiAnYm90dG9tJyxcblx0XHR9LFxuXHRdO1xuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMuX3NlbGVjdFNlcnZpY2Uuc3RhdGUudXBkYXRlKChzdGF0ZSkgPT4gKHtcblx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0aWQ6IGBicm4tc2VsZWN0LSR7bmV4dElkKyt9YCxcblx0XHR9KSk7XG5cdFx0aWYgKHRoaXMubmdDb250cm9sICE9IG51bGwpIHtcblx0XHRcdHRoaXMubmdDb250cm9sLnZhbHVlQWNjZXNzb3IgPSB0aGlzO1xuXHRcdH1cblxuXHRcdC8vIFdhdGNoIGZvciBMaXN0Ym94IFNlbGVjdGlvbiBDaGFuZ2VzIHRvIHRyaWdnZXIgQ29sbGFwc2Vcblx0XHR0aGlzLl9zZWxlY3RTZXJ2aWNlLmxpc3RCb3hWYWx1ZUNoYW5nZUV2ZW50JC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCgpKS5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0aWYgKCF0aGlzLl9tdWx0aXBsZSgpKSB7XG5cdFx0XHRcdHRoaXMuY2xvc2UoKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHRvT2JzZXJ2YWJsZSh0aGlzLl9zZWxlY3RTZXJ2aWNlLnZhbHVlKVxuXHRcdFx0Ly8gc2tpcHBpbmcgZmlyc3QgZWxzZSBuZ2NvbnRyb2wgYWx3YXlzIHN0YXJ0cyBvZmYgYXMgZGlydHkgYW5kIHRyaWdnZXJpbmcgdmFsdWUgY2hhbmdlIG9uIGluaXQgdmFsdWVcblx0XHRcdC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCgpLCBza2lwKDEpKVxuXHRcdFx0LnN1YnNjcmliZSgodmFsdWUpID0+IHRoaXMuX29uQ2hhbmdlKHZhbHVlIHx8IG51bGwpKTtcblxuXHRcdHRvT2JzZXJ2YWJsZSh0aGlzLmRpcilcblx0XHRcdC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCgpKVxuXHRcdFx0LnN1YnNjcmliZSgoKSA9PlxuXHRcdFx0XHR0aGlzLl9zZWxlY3RTZXJ2aWNlLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHRcdFx0Li4uc3RhdGUsXG5cdFx0XHRcdFx0ZGlyOiB0aGlzLmRpcigpLFxuXHRcdFx0XHR9KSksXG5cdFx0XHQpO1xuXHR9XG5cblx0cHVibGljIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcblx0XHQvLyBDaGVjayBpZiBMYWJlbCBEaXJlY3RpdmUgUHJvdmlkZWQgYW5kIHBhc3MgdG8gc2VydmljZVxuXHRcdGlmICh0aGlzLnNlbGVjdExhYmVsKSB7XG5cdFx0XHR0aGlzLmxhYmVsUHJvdmlkZWQuc2V0KHRydWUpO1xuXHRcdFx0dGhpcy5fc2VsZWN0U2VydmljZS5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoe1xuXHRcdFx0XHQuLi5zdGF0ZSxcblx0XHRcdFx0bGFiZWxJZDogdGhpcy5zZWxlY3RMYWJlbC5pZCxcblx0XHRcdFx0ZGlyOiB0aGlzLmRpcigpLFxuXHRcdFx0fSkpO1xuXHRcdH0gZWxzZSBpZiAodGhpcy5fcGxhY2Vob2xkZXIoKSkge1xuXHRcdFx0dGhpcy5fc2VsZWN0U2VydmljZS5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoe1xuXHRcdFx0XHQuLi5zdGF0ZSxcblx0XHRcdFx0bGFiZWxJZDogYCR7c3RhdGUuaWR9LS1sYWJlbGAsXG5cdFx0XHRcdGRpcjogdGhpcy5kaXIoKSxcblx0XHRcdH0pKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgdG9nZ2xlKCk6IHZvaWQge1xuXHRcdGlmICh0aGlzLmlzRXhwYW5kZWQoKSkge1xuXHRcdFx0dGhpcy5jbG9zZSgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLm9wZW4oKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgb3BlbigpOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMuX2Nhbk9wZW4oKSkgcmV0dXJuO1xuXHRcdHRoaXMuX3NlbGVjdFNlcnZpY2Uuc3RhdGUudXBkYXRlKChzdGF0ZSkgPT4gKHtcblx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0aXNFeHBhbmRlZDogdHJ1ZSxcblx0XHR9KSk7XG5cdFx0dGhpcy5vcGVuZWRDaGFuZ2UubmV4dCh0cnVlKTtcblx0XHR0aGlzLl9tb3ZlRm9jdXNUb0NES0xpc3QoKTtcblx0fVxuXG5cdHB1YmxpYyBjbG9zZSgpOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMuaXNFeHBhbmRlZCgpKSByZXR1cm47XG5cblx0XHRpZiAodGhpcy5fc2VsZWN0U2VydmljZS5zZWxlY3RUcmlnZ2VyKSB7XG5cdFx0XHR0aGlzLl9zZWxlY3RTZXJ2aWNlLnNlbGVjdFRyaWdnZXIuZm9jdXMoKTtcblx0XHR9XG5cblx0XHR0aGlzLm9wZW5lZENoYW5nZS5uZXh0KGZhbHNlKTtcblx0XHR0aGlzLl9zZWxlY3RTZXJ2aWNlLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHQuLi5zdGF0ZSxcblx0XHRcdGlzRXhwYW5kZWQ6IGZhbHNlLFxuXHRcdH0pKTtcblx0XHR0aGlzLl9vblRvdWNoZWQoKTtcblx0fVxuXG5cdHByb3RlY3RlZCBfY2FuT3BlbigpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gIXRoaXMuaXNFeHBhbmRlZCgpICYmICF0aGlzLl9kaXNhYmxlZCgpICYmIHRoaXMub3B0aW9ucz8ubGVuZ3RoID4gMDtcblx0fVxuXG5cdHByaXZhdGUgX21vdmVGb2N1c1RvQ0RLTGlzdCgpOiB2b2lkIHtcblx0XHRzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2VsZWN0Q29udGVudC5mb2N1c0xpc3QoKSk7XG5cdH1cblxuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuXHRwdWJsaWMgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XG5cdFx0dGhpcy5fc2VsZWN0U2VydmljZS5zZXRJbml0aWFsU2VsZWN0ZWRPcHRpb25zKHZhbHVlKTtcblx0fVxuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5cdHB1YmxpYyByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpOiB2b2lkIHtcblx0XHR0aGlzLl9vbkNoYW5nZSA9IGZuO1xuXHR9XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0cHVibGljIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpOiB2b2lkIHtcblx0XHR0aGlzLl9vblRvdWNoZWQgPSBmbjtcblx0fVxuXG5cdHB1YmxpYyBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pIHtcblx0XHR0aGlzLmRpc2FibGVkID0gaXNEaXNhYmxlZDtcblx0fVxufVxuIl19