import { Injectable, computed, signal } from '@angular/core';
import { takeUntilDestroyed, toObservable } from '@angular/core/rxjs-interop';
import { Subject, skip } from 'rxjs';
import * as i0 from "@angular/core";
export class BrnSelectService {
    get selectTrigger() {
        return this._selectTrigger;
    }
    constructor() {
        this.state = signal({
            id: '',
            labelId: '',
            panelId: '',
            placeholder: '',
            isExpanded: false,
            multiple: false,
            disabled: false,
            dir: 'ltr',
            selectedOptions: [],
            initialSelectedOptions: [],
            value: '',
            triggerWidth: 0,
        });
        this.id = computed(() => this.state().id);
        this.labelId = computed(() => this.state().labelId);
        this.panelId = computed(() => this.state().panelId);
        this.placeholder = computed(() => this.state().placeholder);
        this.disabled = computed(() => this.state().disabled);
        this.isExpanded = computed(() => this.state().isExpanded);
        this.multiple = computed(() => this.state().multiple);
        this.dir = computed(() => this.state().dir);
        this.selectedOptions = computed(() => this.state().selectedOptions);
        this.initialSelectedOptions = computed(() => this.state().initialSelectedOptions);
        this.value = computed(() => this.state().value);
        this.triggerWidth = computed(() => this.state().triggerWidth);
        this.possibleOptions = computed(() => this._possibleOptions());
        this._possibleOptions = signal([]);
        this.multiple$ = toObservable(this.multiple);
        this.listBoxValueChangeEvent$ = new Subject();
        this.listBoxValueChangeEvent$.pipe(takeUntilDestroyed()).subscribe((listBoxChange) => {
            const updatedSelections = this.multiple() ? this.getUpdatedOptions(listBoxChange) : [listBoxChange.option];
            const value = this.multiple() ? listBoxChange.value : listBoxChange.value[0];
            this.state.update((state) => ({
                ...state,
                selectedOptions: [...updatedSelections],
                value: value,
            }));
        });
        // We need to skip the first value because we don't want to deselect all options when the component is initialized with a preselected value e.g. by the form control
        this.multiple$.pipe(skip(1), takeUntilDestroyed()).subscribe((multiple) => {
            if (!multiple && this.value().length > 1) {
                this.deselectAllOptions();
            }
        });
    }
    setTriggerWidth(triggerWidth) {
        this.state.update((s) => ({ ...s, triggerWidth }));
    }
    getUpdatedOptions(latestListboxChange) {
        const isNewSelection = latestListboxChange.value.findIndex((value) => value === latestListboxChange.option?.value);
        if (isNewSelection === -1) {
            const removedOptionIndex = this.selectedOptions().findIndex((option) => latestListboxChange.option === option);
            const options = this.selectedOptions();
            options.splice(removedOptionIndex, 1);
            return options;
        }
        return [...this.selectedOptions(), latestListboxChange.option];
    }
    deselectAllOptions() {
        this.state.update((state) => ({
            ...state,
            selectedOptions: [],
            value: [],
        }));
    }
    // Needed due to https://github.com/angular/angular/issues/20810
    _setSelectTrigger(trigger) {
        this._selectTrigger = trigger;
    }
    registerOption(option) {
        this._possibleOptions.update((options) => [...options, option]);
    }
    deregisterOption(option) {
        this._possibleOptions.update((options) => options.filter((o) => o !== option));
    }
    setInitialSelectedOptions(value) {
        this.selectOptionByValue(value);
        this.state.update((state) => ({
            ...state,
            initialSelectedOptions: this.selectedOptions(),
        }));
    }
    selectOptionByValue(value) {
        if (value === null || value === undefined) {
            this.state.update((state) => ({
                ...state,
                selectedOptions: [],
                value: this.multiple() ? [] : '',
            }));
            return;
        }
        const options = this._possibleOptions();
        if (this.multiple()) {
            const selectedOptions = options.filter((option) => {
                if (Array.isArray(value)) {
                    return value.includes(option?.value);
                }
                return value === option?.value;
            });
            this.state.update((state) => ({
                ...state,
                selectedOptions,
                value: value,
            }));
        }
        else {
            const selectedOption = options.find((option) => option?.value === value);
            if (!selectedOption) {
                return;
            }
            this.state.update((state) => ({
                ...state,
                selectedOptions: [selectedOption],
                value: selectedOption.value,
            }));
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnSelectService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnSelectService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.5", ngImport: i0, type: BrnSelectService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJuLXNlbGVjdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy91aS9zZWxlY3QvYnJhaW4vc3JjL2xpYi9icm4tc2VsZWN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFNckMsTUFBTSxPQUFPLGdCQUFnQjtJQWlENUIsSUFBSSxhQUFhO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM1QixDQUFDO0lBRUQ7UUFwRGdCLFVBQUssR0FBRyxNQUFNLENBYTNCO1lBQ0YsRUFBRSxFQUFFLEVBQUU7WUFDTixPQUFPLEVBQUUsRUFBRTtZQUNYLE9BQU8sRUFBRSxFQUFFO1lBQ1gsV0FBVyxFQUFFLEVBQUU7WUFDZixVQUFVLEVBQUUsS0FBSztZQUNqQixRQUFRLEVBQUUsS0FBSztZQUNmLFFBQVEsRUFBRSxLQUFLO1lBQ2YsR0FBRyxFQUFFLEtBQUs7WUFDVixlQUFlLEVBQUUsRUFBRTtZQUNuQixzQkFBc0IsRUFBRSxFQUFFO1lBQzFCLEtBQUssRUFBRSxFQUFFO1lBQ1QsWUFBWSxFQUFFLENBQUM7U0FDZixDQUFDLENBQUM7UUFFYSxPQUFFLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyQyxZQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQyxZQUFPLEdBQUcsUUFBUSxDQUFDLEdB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QUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztZQUNyQixNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQ2pELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUMxQixPQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEtBQWUsQ0FBQyxDQUFDO2dCQUNoRCxDQUFDO2dCQUNELE9BQU8sS0FBSyxLQUFLLE1BQU0sRUFBRSxLQUFLLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDN0IsR0FBRyxLQUFLO2dCQUNSLGVBQWU7Z0JBQ2YsS0FBSyxFQUFFLEtBQWlCO2FBQ3hCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQzthQUFNLENBQUM7WUFDUCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxLQUFLLEtBQUssQ0FBQyxDQUFDO1lBQ3pFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDckIsT0FBTztZQUNSLENBQUM7WUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDN0IsR0FBRyxLQUFLO2dCQUNSLGVBQWUsRUFBRSxDQUFDLGNBQWtDLENBQUM7Z0JBQ3JELEtBQUssRUFBRSxjQUFjLENBQUMsS0FBZTthQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDRixDQUFDOzhHQXZKVyxnQkFBZ0I7a0hBQWhCLGdCQUFnQjs7MkZBQWhCLGdCQUFnQjtrQkFENUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ2RrT3B0aW9uLCBMaXN0Ym94VmFsdWVDaGFuZ2VFdmVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9saXN0Ym94JztcbmltcG9ydCB7IEluamVjdGFibGUsIGNvbXB1dGVkLCBzaWduYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHRha2VVbnRpbERlc3Ryb3llZCwgdG9PYnNlcnZhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnO1xuaW1wb3J0IHsgU3ViamVjdCwgc2tpcCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHR5cGUgeyBCcm5TZWxlY3RUcmlnZ2VyRGlyZWN0aXZlIH0gZnJvbSAnLi9icm4tc2VsZWN0LXRyaWdnZXIuZGlyZWN0aXZlJztcblxudHlwZSBCcm5SZWFkRGlyZWN0aW9uID0gJ2x0cicgfCAncnRsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJyblNlbGVjdFNlcnZpY2Uge1xuXHRwdWJsaWMgcmVhZG9ubHkgc3RhdGUgPSBzaWduYWw8e1xuXHRcdGlkOiBzdHJpbmc7XG5cdFx0bGFiZWxJZDogc3RyaW5nO1xuXHRcdHBhbmVsSWQ6IHN0cmluZztcblx0XHRwbGFjZWhvbGRlcjogc3RyaW5nO1xuXHRcdGlzRXhwYW5kZWQ6IGJvb2xlYW47XG5cdFx0bXVsdGlwbGU6IGJvb2xlYW47XG5cdFx0ZGlzYWJsZWQ6IGJvb2xlYW47XG5cdFx0ZGlyOiBCcm5SZWFkRGlyZWN0aW9uO1xuXHRcdHNlbGVjdGVkT3B0aW9uczogQXJyYXk8Q2RrT3B0aW9uIHwgbnVsbD47XG5cdFx0aW5pdGlhbFNlbGVjdGVkT3B0aW9uczogQXJyYXk8Q2RrT3B0aW9uIHwgbnVsbD47XG5cdFx0dmFsdWU6IHN0cmluZyB8IHN0cmluZ1tdO1xuXHRcdHRyaWdnZXJXaWR0aDogbnVtYmVyO1xuXHR9Pih7XG5cdFx0aWQ6ICcnLFxuXHRcdGxhYmVsSWQ6ICcnLFxuXHRcdHBhbmVsSWQ6ICcnLFxuXHRcdHBsYWNlaG9sZGVyOiAnJyxcblx0XHRpc0V4cGFuZGVkOiBmYWxzZSxcblx0XHRtdWx0aXBsZTogZmFsc2UsXG5cdFx0ZGlzYWJsZWQ6IGZhbHNlLFxuXHRcdGRpcjogJ2x0cicsXG5cdFx0c2VsZWN0ZWRPcHRpb25zOiBbXSxcblx0XHRpbml0aWFsU2VsZWN0ZWRPcHRpb25zOiBbXSxcblx0XHR2YWx1ZTogJycsXG5cdFx0dHJpZ2dlcldpZHRoOiAwLFxuXHR9KTtcblxuXHRwdWJsaWMgcmVhZG9ubHkgaWQgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkuaWQpO1xuXHRwdWJsaWMgcmVhZG9ubHkgbGFiZWxJZCA9IGNvbXB1dGVkKCgpID0+IHRoaXMuc3RhdGUoKS5sYWJlbElkKTtcblx0cHVibGljIHJlYWRvbmx5IHBhbmVsSWQgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkucGFuZWxJZCk7XG5cdHB1YmxpYyByZWFkb25seSBwbGFjZWhvbGRlciA9IGNvbXB1dGVkKCgpID0+IHRoaXMuc3RhdGUoKS5wbGFjZWhvbGRlcik7XG5cdHB1YmxpYyByZWFkb25seSBkaXNhYmxlZCA9IGNvbXB1dGVkKCgpID0+IHRoaXMuc3RhdGUoKS5kaXNhYmxlZCk7XG5cdHB1YmxpYyByZWFkb25seSBpc0V4cGFuZGVkID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5zdGF0ZSgpLmlzRXhwYW5kZWQpO1xuXHRwdWJsaWMgcmVhZG9ubHkgbXVsdGlwbGUgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkubXVsdGlwbGUpO1xuXHRwdWJsaWMgcmVhZG9ubHkgZGlyID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5zdGF0ZSgpLmRpcik7XG5cdHB1YmxpYyByZWFkb25seSBzZWxlY3RlZE9wdGlvbnMgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkuc2VsZWN0ZWRPcHRpb25zKTtcblx0cHVibGljIHJlYWRvbmx5IGluaXRpYWxTZWxlY3RlZE9wdGlvbnMgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkuaW5pdGlhbFNlbGVjdGVkT3B0aW9ucyk7XG5cdHB1YmxpYyByZWFkb25seSB2YWx1ZSA9IGNvbXB1dGVkKCgpID0+IHRoaXMuc3RhdGUoKS52YWx1ZSk7XG5cdHB1YmxpYyByZWFkb25seSB0cmlnZ2VyV2lkdGggPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkudHJpZ2dlcldpZHRoKTtcblx0cHVibGljIHJlYWRvbmx5IHBvc3NpYmxlT3B0aW9ucyA9IGNvbXB1dGVkKCgpID0+IHRoaXMuX3Bvc3NpYmxlT3B0aW9ucygpKTtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wb3NzaWJsZU9wdGlvbnMgPSBzaWduYWw8QXJyYXk8Q2RrT3B0aW9uIHwgbnVsbD4+KFtdKTtcblx0cHJpdmF0ZSByZWFkb25seSBtdWx0aXBsZSQgPSB0b09ic2VydmFibGUodGhpcy5tdWx0aXBsZSk7XG5cblx0cHVibGljIHJlYWRvbmx5IGxpc3RCb3hWYWx1ZUNoYW5nZUV2ZW50JCA9IG5ldyBTdWJqZWN0PExpc3Rib3hWYWx1ZUNoYW5nZUV2ZW50PHVua25vd24+PigpO1xuXG5cdHByaXZhdGUgX3NlbGVjdFRyaWdnZXI/OiBCcm5TZWxlY3RUcmlnZ2VyRGlyZWN0aXZlO1xuXHRnZXQgc2VsZWN0VHJpZ2dlcigpIHtcblx0XHRyZXR1cm4gdGhpcy5fc2VsZWN0VHJpZ2dlcjtcblx0fVxuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMubGlzdEJveFZhbHVlQ2hhbmdlRXZlbnQkLnBpcGUodGFrZVVudGlsRGVzdHJveWVkKCkpLnN1YnNjcmliZSgobGlzdEJveENoYW5nZSkgPT4ge1xuXHRcdFx0Y29uc3QgdXBkYXRlZFNlbGVjdGlvbnMgPSB0aGlzLm11bHRpcGxlKCkgPyB0aGlzLmdldFVwZGF0ZWRPcHRpb25zKGxpc3RCb3hDaGFuZ2UpIDogW2xpc3RCb3hDaGFuZ2Uub3B0aW9uXTtcblx0XHRcdGNvbnN0IHZhbHVlID0gdGhpcy5tdWx0aXBsZSgpID8gbGlzdEJveENoYW5nZS52YWx1ZSA6IGxpc3RCb3hDaGFuZ2UudmFsdWVbMF07XG5cdFx0XHR0aGlzLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0XHRzZWxlY3RlZE9wdGlvbnM6IFsuLi51cGRhdGVkU2VsZWN0aW9uc10sXG5cdFx0XHRcdHZhbHVlOiB2YWx1ZSBhcyBzdHJpbmcgfCBzdHJpbmdbXSxcblx0XHRcdH0pKTtcblx0XHR9KTtcblxuXHRcdC8vIFdlIG5lZWQgdG8gc2tpcCB0aGUgZmlyc3QgdmFsdWUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IHRvIGRlc2VsZWN0IGFsbCBvcHRpb25zIHdoZW4gdGhlIGNvbXBvbmVudCBpcyBpbml0aWFsaXplZCB3aXRoIGEgcHJlc2VsZWN0ZWQgdmFsdWUgZS5nLiBieSB0aGUgZm9ybSBjb250cm9sXG5cdFx0dGhpcy5tdWx0aXBsZSQucGlwZShza2lwKDEpLCB0YWtlVW50aWxEZXN0cm95ZWQoKSkuc3Vic2NyaWJlKChtdWx0aXBsZSkgPT4ge1xuXHRcdFx0aWYgKCFtdWx0aXBsZSAmJiB0aGlzLnZhbHVlKCkubGVuZ3RoID4gMSkge1xuXHRcdFx0XHR0aGlzLmRlc2VsZWN0QWxsT3B0aW9ucygpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIHNldFRyaWdnZXJXaWR0aCh0cmlnZ2VyV2lkdGg6IG51bWJlcikge1xuXHRcdHRoaXMuc3RhdGUudXBkYXRlKChzKSA9PiAoeyAuLi5zLCB0cmlnZ2VyV2lkdGggfSkpO1xuXHR9XG5cblx0cHVibGljIGdldFVwZGF0ZWRPcHRpb25zKGxhdGVzdExpc3Rib3hDaGFuZ2U6IExpc3Rib3hWYWx1ZUNoYW5nZUV2ZW50PHVua25vd24+KTogQXJyYXk8Q2RrT3B0aW9uIHwgbnVsbD4ge1xuXHRcdGNvbnN0IGlzTmV3U2VsZWN0aW9uID0gbGF0ZXN0TGlzdGJveENoYW5nZS52YWx1ZS5maW5kSW5kZXgoKHZhbHVlKSA9PiB2YWx1ZSA9PT0gbGF0ZXN0TGlzdGJveENoYW5nZS5vcHRpb24/LnZhbHVlKTtcblx0XHRpZiAoaXNOZXdTZWxlY3Rpb24gPT09IC0xKSB7XG5cdFx0XHRjb25zdCByZW1vdmVkT3B0aW9uSW5kZXggPSB0aGlzLnNlbGVjdGVkT3B0aW9ucygpLmZpbmRJbmRleCgob3B0aW9uKSA9PiBsYXRlc3RMaXN0Ym94Q2hhbmdlLm9wdGlvbiA9PT0gb3B0aW9uKTtcblx0XHRcdGNvbnN0IG9wdGlvbnMgPSB0aGlzLnNlbGVjdGVkT3B0aW9ucygpO1xuXHRcdFx0b3B0aW9ucy5zcGxpY2UocmVtb3ZlZE9wdGlvbkluZGV4LCAxKTtcblx0XHRcdHJldHVybiBvcHRpb25zO1xuXHRcdH1cblx0XHRyZXR1cm4gWy4uLnRoaXMuc2VsZWN0ZWRPcHRpb25zKCksIGxhdGVzdExpc3Rib3hDaGFuZ2Uub3B0aW9uXTtcblx0fVxuXG5cdHB1YmxpYyBkZXNlbGVjdEFsbE9wdGlvbnMoKSB7XG5cdFx0dGhpcy5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoe1xuXHRcdFx0Li4uc3RhdGUsXG5cdFx0XHRzZWxlY3RlZE9wdGlvbnM6IFtdLFxuXHRcdFx0dmFsdWU6IFtdLFxuXHRcdH0pKTtcblx0fVxuXG5cdC8vIE5lZWRlZCBkdWUgdG8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvMjA4MTBcblx0cHVibGljIF9zZXRTZWxlY3RUcmlnZ2VyKHRyaWdnZXI6IEJyblNlbGVjdFRyaWdnZXJEaXJlY3RpdmUpIHtcblx0XHR0aGlzLl9zZWxlY3RUcmlnZ2VyID0gdHJpZ2dlcjtcblx0fVxuXG5cdHB1YmxpYyByZWdpc3Rlck9wdGlvbihvcHRpb246IENka09wdGlvbiB8IG51bGwpIHtcblx0XHR0aGlzLl9wb3NzaWJsZU9wdGlvbnMudXBkYXRlKChvcHRpb25zKSA9PiBbLi4ub3B0aW9ucywgb3B0aW9uXSk7XG5cdH1cblxuXHRwdWJsaWMgZGVyZWdpc3Rlck9wdGlvbihvcHRpb246IENka09wdGlvbiB8IG51bGwpIHtcblx0XHR0aGlzLl9wb3NzaWJsZU9wdGlvbnMudXBkYXRlKChvcHRpb25zKSA9PiBvcHRpb25zLmZpbHRlcigobykgPT4gbyAhPT0gb3B0aW9uKSk7XG5cdH1cblxuXHRwdWJsaWMgc2V0SW5pdGlhbFNlbGVjdGVkT3B0aW9ucyh2YWx1ZTogdW5rbm93bikge1xuXHRcdHRoaXMuc2VsZWN0T3B0aW9uQnlWYWx1ZSh2YWx1ZSk7XG5cdFx0dGhpcy5zdGF0ZS51cGRhdGUoKHN0YXRlKSA9PiAoe1xuXHRcdFx0Li4uc3RhdGUsXG5cdFx0XHRpbml0aWFsU2VsZWN0ZWRPcHRpb25zOiB0aGlzLnNlbGVjdGVkT3B0aW9ucygpLFxuXHRcdH0pKTtcblx0fVxuXG5cdHByaXZhdGUgc2VsZWN0T3B0aW9uQnlWYWx1ZSh2YWx1ZTogdW5rbm93bikge1xuXHRcdGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aGlzLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0XHRzZWxlY3RlZE9wdGlvbnM6IFtdLFxuXHRcdFx0XHR2YWx1ZTogdGhpcy5tdWx0aXBsZSgpID8gW10gOiAnJyxcblx0XHRcdH0pKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBvcHRpb25zID0gdGhpcy5fcG9zc2libGVPcHRpb25zKCk7XG5cblx0XHRpZiAodGhpcy5tdWx0aXBsZSgpKSB7XG5cdFx0XHRjb25zdCBzZWxlY3RlZE9wdGlvbnMgPSBvcHRpb25zLmZpbHRlcigob3B0aW9uKSA9PiB7XG5cdFx0XHRcdGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuXHRcdFx0XHRcdHJldHVybiB2YWx1ZS5pbmNsdWRlcyhvcHRpb24/LnZhbHVlIGFzIHN0cmluZyk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIHZhbHVlID09PSBvcHRpb24/LnZhbHVlO1xuXHRcdFx0fSk7XG5cdFx0XHR0aGlzLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0XHRzZWxlY3RlZE9wdGlvbnMsXG5cdFx0XHRcdHZhbHVlOiB2YWx1ZSBhcyBzdHJpbmdbXSxcblx0XHRcdH0pKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3Qgc2VsZWN0ZWRPcHRpb24gPSBvcHRpb25zLmZpbmQoKG9wdGlvbikgPT4gb3B0aW9uPy52YWx1ZSA9PT0gdmFsdWUpO1xuXHRcdFx0aWYgKCFzZWxlY3RlZE9wdGlvbikge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHR0aGlzLnN0YXRlLnVwZGF0ZSgoc3RhdGUpID0+ICh7XG5cdFx0XHRcdC4uLnN0YXRlLFxuXHRcdFx0XHRzZWxlY3RlZE9wdGlvbnM6IFtzZWxlY3RlZE9wdGlvbiBhcyBDZGtPcHRpb24gfCBudWxsXSxcblx0XHRcdFx0dmFsdWU6IHNlbGVjdGVkT3B0aW9uLnZhbHVlIGFzIHN0cmluZyxcblx0XHRcdH0pKTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==