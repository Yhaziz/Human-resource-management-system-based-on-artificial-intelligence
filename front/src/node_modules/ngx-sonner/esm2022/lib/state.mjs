import { signal } from '@angular/core';
let toastsCounter = 0;
function createToastState() {
    const toasts = signal([]);
    const heights = signal([]);
    function addToast(data) {
        toasts.update(prev => [data, ...prev]);
    }
    function create(data) {
        const { message, ...rest } = data;
        const id = typeof data?.id === 'number' || (data.id && data.id?.length > 0)
            ? data.id
            : toastsCounter++;
        const dismissable = data.dismissable ?? true;
        const type = data.type ?? 'default';
        const alreadyExists = toasts().find(toast => toast.id === id);
        if (alreadyExists) {
            toasts.update(prev => prev.map(toast => {
                if (toast.id === id) {
                    return {
                        ...toast,
                        ...data,
                        id,
                        title: message,
                        dismissable,
                        type,
                        updated: true,
                    };
                }
                else
                    return { ...toast, updated: false };
            }));
        }
        else {
            addToast({ ...rest, id, title: message, dismissable, type });
        }
        return id;
    }
    function dismiss(id) {
        if (id === undefined) {
            toasts.set([]);
            return;
        }
        toasts.update(prev => prev.filter(toast => toast.id !== id));
        return id;
    }
    function message(message, data) {
        return create({ ...data, type: 'default', message });
    }
    function error(message, data) {
        return create({ ...data, type: 'error', message });
    }
    function success(message, data) {
        return create({ ...data, type: 'success', message });
    }
    function info(message, data) {
        return create({ ...data, type: 'info', message });
    }
    function warning(message, data) {
        return create({ ...data, type: 'warning', message });
    }
    function loading(message, data) {
        return create({ ...data, type: 'loading', message });
    }
    function promise(promise, data) {
        if (!data)
            return;
        let id = undefined;
        if (data.loading !== undefined) {
            id = create({
                ...data,
                promise,
                type: 'loading',
                message: data.loading,
            });
        }
        const p = promise instanceof Promise ? promise : promise();
        let shouldDismiss = id !== undefined;
        p.then(response => {
            // @ts-expect-error: Incorrect response type
            if (response && typeof response.ok === 'boolean' && !response.ok) {
                shouldDismiss = false;
                const message = typeof data.error === 'function'
                    ? // @ts-expect-error: TODO: Better function checking
                        data.error(`HTTP error! status: ${response.status}`)
                    : data.error;
                create({ id, type: 'error', message });
            }
            else if (data.success !== undefined) {
                shouldDismiss = false;
                const message = typeof data.success === 'function'
                    ? // @ts-expect-error: TODO: Better function checking
                        data.success(response)
                    : data.success;
                create({ id, type: 'success', message });
            }
        })
            .catch(error => {
            if (data.error !== undefined) {
                shouldDismiss = false;
                const message = 
                // @ts-expect-error: TODO: Better function checking
                typeof data.error === 'function' ? data.error(error) : data.error;
                create({ id, type: 'error', message });
            }
        })
            .finally(() => {
            if (shouldDismiss) {
                // Toast is still in load state (and will be indefinitely â€” dismiss it)
                dismiss(id);
                id = undefined;
            }
            data.finally?.();
        });
        return id;
    }
    function custom(component, data) {
        const id = data?.id ?? toastsCounter++;
        create({ component, id, ...data });
        return id;
    }
    function removeHeight(id) {
        heights.update(prev => prev.filter(height => height.toastId !== id));
    }
    function addHeight(height) {
        heights.update(prev => [height, ...prev]);
    }
    function reset() {
        toasts.set([]);
        heights.set([]);
    }
    return {
        //methods
        create,
        addToast,
        dismiss,
        message,
        error,
        success,
        info,
        warning,
        loading,
        promise,
        custom,
        removeHeight,
        addHeight,
        reset,
        // signals
        toasts: toasts.asReadonly(),
        heights: heights.asReadonly(),
    };
}
export const toastState = createToastState();
// bind this to the toast function
function toastFunction(message, data) {
    return toastState.create({
        message,
        ...data,
    });
}
const basicToast = toastFunction;
export const toast = Object.assign(basicToast, {
    success: toastState.success,
    info: toastState.info,
    warning: toastState.warning,
    error: toastState.error,
    custom: toastState.custom,
    message: toastState.message,
    promise: toastState.promise,
    dismiss: toastState.dismiss,
    loading: toastState.loading,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neC1zb25uZXIvc3JjL2xpYi9zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFRLE1BQU0sZUFBZSxDQUFDO0FBVTdDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV0QixTQUFTLGdCQUFnQjtJQUN2QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQVcsRUFBRSxDQUFDLENBQUM7SUFDcEMsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFZLEVBQUUsQ0FBQyxDQUFDO0lBRXRDLFNBQVMsUUFBUSxDQUFDLElBQVk7UUFDNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsU0FBUyxNQUFNLENBQ2IsSUFJQztRQUVELE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDbEMsTUFBTSxFQUFFLEdBQ04sT0FBTyxJQUFJLEVBQUUsRUFBRSxLQUFLLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQzlELENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNULENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUV0QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztRQUM3QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQztRQUVwQyxNQUFNLGFBQWEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFD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QUMsT0FBTztJQUMzQixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7SUFDdkIsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNO0lBQ3pCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztJQUMzQixPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87SUFDM0IsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPO0lBQzNCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztDQUM1QixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaWduYWwsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEV4dGVybmFsVG9hc3QsXG4gIEhlaWdodFQsXG4gIFByb21pc2VEYXRhLFxuICBQcm9taXNlVCxcbiAgVG9hc3RULFxuICBUb2FzdFR5cGVzLFxufSBmcm9tICcuL3R5cGVzJztcblxubGV0IHRvYXN0c0NvdW50ZXIgPSAwO1xuXG5mdW5jdGlvbiBjcmVhdGVUb2FzdFN0YXRlKCkge1xuICBjb25zdCB0b2FzdHMgPSBzaWduYWw8VG9hc3RUW10+KFtdKTtcbiAgY29uc3QgaGVpZ2h0cyA9IHNpZ25hbDxIZWlnaHRUW10+KFtdKTtcblxuICBmdW5jdGlvbiBhZGRUb2FzdChkYXRhOiBUb2FzdFQpIHtcbiAgICB0b2FzdHMudXBkYXRlKHByZXYgPT4gW2RhdGEsIC4uLnByZXZdKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNyZWF0ZShcbiAgICBkYXRhOiBFeHRlcm5hbFRvYXN0ICYge1xuICAgICAgbWVzc2FnZT86IHN0cmluZyB8IFR5cGU8dW5rbm93bj47XG4gICAgICB0eXBlPzogVG9hc3RUeXBlcztcbiAgICAgIHByb21pc2U/OiBQcm9taXNlVDtcbiAgICB9XG4gICkge1xuICAgIGNvbnN0IHsgbWVzc2FnZSwgLi4ucmVzdCB9ID0gZGF0YTtcbiAgICBjb25zdCBpZCA9XG4gICAgICB0eXBlb2YgZGF0YT8uaWQgPT09ICdudW1iZXInIHx8IChkYXRhLmlkICYmIGRhdGEuaWQ/Lmxlbmd0aCA+IDApXG4gICAgICAgID8gZGF0YS5pZFxuICAgICAgICA6IHRvYXN0c0NvdW50ZXIrKztcblxuICAgIGNvbnN0IGRpc21pc3NhYmxlID0gZGF0YS5kaXNtaXNzYWJsZSA/PyB0cnVlO1xuICAgIGNvbnN0IHR5cGUgPSBkYXRhLnR5cGUgPz8gJ2RlZmF1bHQnO1xuXG4gICAgY29uc3QgYWxyZWFkeUV4aXN0cyA9IHRvYXN0cygpLmZpbmQodG9hc3QgPT4gdG9hc3QuaWQgPT09IGlkKTtcblxuICAgIGlmIChhbHJlYWR5RXhpc3RzKSB7XG4gICAgICB0b2FzdHMudXBkYXRlKHByZXYgPT5cbiAgICAgICAgcHJldi5tYXAodG9hc3QgPT4ge1xuICAgICAgICAgIGlmICh0b2FzdC5pZCA9PT0gaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIC4uLnRvYXN0LFxuICAgICAgICAgICAgICAuLi5kYXRhLFxuICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgdGl0bGU6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgIGRpc21pc3NhYmxlLFxuICAgICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgICB1cGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9IGVsc2UgcmV0dXJuIHsgLi4udG9hc3QsIHVwZGF0ZWQ6IGZhbHNlIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBhZGRUb2FzdCh7IC4uLnJlc3QsIGlkLCB0aXRsZTogbWVzc2FnZSwgZGlzbWlzc2FibGUsIHR5cGUgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgZnVuY3Rpb24gZGlzbWlzcyhpZD86IG51bWJlciB8IHN0cmluZykge1xuICAgIGlmIChpZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0b2FzdHMuc2V0KFtdKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdG9hc3RzLnVwZGF0ZShwcmV2ID0+IHByZXYuZmlsdGVyKHRvYXN0ID0+IHRvYXN0LmlkICE9PSBpZCkpO1xuXG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgZnVuY3Rpb24gbWVzc2FnZShtZXNzYWdlOiBzdHJpbmcgfCBUeXBlPHVua25vd24+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIHJldHVybiBjcmVhdGUoeyAuLi5kYXRhLCB0eXBlOiAnZGVmYXVsdCcsIG1lc3NhZ2UgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBlcnJvcihtZXNzYWdlOiBzdHJpbmcgfCBUeXBlPHVua25vd24+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIHJldHVybiBjcmVhdGUoeyAuLi5kYXRhLCB0eXBlOiAnZXJyb3InLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gc3VjY2VzcyhtZXNzYWdlOiBzdHJpbmcgfCBUeXBlPHVua25vd24+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIHJldHVybiBjcmVhdGUoeyAuLi5kYXRhLCB0eXBlOiAnc3VjY2VzcycsIG1lc3NhZ2UgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBpbmZvKG1lc3NhZ2U6IHN0cmluZyB8IFR5cGU8dW5rbm93bj4sIGRhdGE/OiBFeHRlcm5hbFRvYXN0KSB7XG4gICAgcmV0dXJuIGNyZWF0ZSh7IC4uLmRhdGEsIHR5cGU6ICdpbmZvJywgbWVzc2FnZSB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHdhcm5pbmcobWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgICByZXR1cm4gY3JlYXRlKHsgLi4uZGF0YSwgdHlwZTogJ3dhcm5pbmcnLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbG9hZGluZyhtZXNzYWdlOiBzdHJpbmcgfCBUeXBlPHVua25vd24+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIHJldHVybiBjcmVhdGUoeyAuLi5kYXRhLCB0eXBlOiAnbG9hZGluZycsIG1lc3NhZ2UgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwcm9taXNlPFRvYXN0RGF0YT4oXG4gICAgcHJvbWlzZTogUHJvbWlzZVQ8VG9hc3REYXRhPixcbiAgICBkYXRhPzogUHJvbWlzZURhdGE8VG9hc3REYXRhPlxuICApIHtcbiAgICBpZiAoIWRhdGEpIHJldHVybjtcblxuICAgIGxldCBpZDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgIGlmIChkYXRhLmxvYWRpbmcgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWQgPSBjcmVhdGUoe1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBwcm9taXNlLFxuICAgICAgICB0eXBlOiAnbG9hZGluZycsXG4gICAgICAgIG1lc3NhZ2U6IGRhdGEubG9hZGluZyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHAgPSBwcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSA/IHByb21pc2UgOiBwcm9taXNlKCk7XG5cbiAgICBsZXQgc2hvdWxkRGlzbWlzcyA9IGlkICE9PSB1bmRlZmluZWQ7XG5cbiAgICBwLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcjogSW5jb3JyZWN0IHJlc3BvbnNlIHR5cGVcbiAgICAgIGlmIChyZXNwb25zZSAmJiB0eXBlb2YgcmVzcG9uc2Uub2sgPT09ICdib29sZWFuJyAmJiAhcmVzcG9uc2Uub2spIHtcbiAgICAgICAgc2hvdWxkRGlzbWlzcyA9IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgICAgIHR5cGVvZiBkYXRhLmVycm9yID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICA/IC8vIEB0cy1leHBlY3QtZXJyb3I6IFRPRE86IEJldHRlciBmdW5jdGlvbiBjaGVja2luZ1xuICAgICAgICAgICAgICBkYXRhLmVycm9yKGBIVFRQIGVycm9yISBzdGF0dXM6ICR7cmVzcG9uc2Uuc3RhdHVzfWApXG4gICAgICAgICAgICA6IGRhdGEuZXJyb3I7XG4gICAgICAgIGNyZWF0ZSh7IGlkLCB0eXBlOiAnZXJyb3InLCBtZXNzYWdlIH0pO1xuICAgICAgfSBlbHNlIGlmIChkYXRhLnN1Y2Nlc3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBzaG91bGREaXNtaXNzID0gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZSA9XG4gICAgICAgICAgdHlwZW9mIGRhdGEuc3VjY2VzcyA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgPyAvLyBAdHMtZXhwZWN0LWVycm9yOiBUT0RPOiBCZXR0ZXIgZnVuY3Rpb24gY2hlY2tpbmdcbiAgICAgICAgICAgICAgZGF0YS5zdWNjZXNzKHJlc3BvbnNlKVxuICAgICAgICAgICAgOiBkYXRhLnN1Y2Nlc3M7XG4gICAgICAgIGNyZWF0ZSh7IGlkLCB0eXBlOiAnc3VjY2VzcycsIG1lc3NhZ2UgfSk7XG4gICAgICB9XG4gICAgfSlcbiAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgIGlmIChkYXRhLmVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBzaG91bGREaXNtaXNzID0gZmFsc2U7XG4gICAgICAgICAgY29uc3QgbWVzc2FnZSA9XG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yOiBUT0RPOiBCZXR0ZXIgZnVuY3Rpb24gY2hlY2tpbmdcbiAgICAgICAgICAgIHR5cGVvZiBkYXRhLmVycm9yID09PSAnZnVuY3Rpb24nID8gZGF0YS5lcnJvcihlcnJvcikgOiBkYXRhLmVycm9yO1xuICAgICAgICAgIGNyZWF0ZSh7IGlkLCB0eXBlOiAnZXJyb3InLCBtZXNzYWdlIH0pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICBpZiAoc2hvdWxkRGlzbWlzcykge1xuICAgICAgICAgIC8vIFRvYXN0IGlzIHN0aWxsIGluIGxvYWQgc3RhdGUgKGFuZCB3aWxsIGJlIGluZGVmaW5pdGVseSDigJQgZGlzbWlzcyBpdClcbiAgICAgICAgICBkaXNtaXNzKGlkKTtcbiAgICAgICAgICBpZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGRhdGEuZmluYWxseT8uKCk7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBpZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGN1c3RvbTxUPihjb21wb25lbnQ6IFR5cGU8VD4sIGRhdGE/OiBFeHRlcm5hbFRvYXN0KSB7XG4gICAgY29uc3QgaWQgPSBkYXRhPy5pZCA/PyB0b2FzdHNDb3VudGVyKys7XG4gICAgY3JlYXRlKHsgY29tcG9uZW50LCBpZCwgLi4uZGF0YSB9KTtcblxuICAgIHJldHVybiBpZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlbW92ZUhlaWdodChpZDogbnVtYmVyIHwgc3RyaW5nKSB7XG4gICAgaGVpZ2h0cy51cGRhdGUocHJldiA9PiBwcmV2LmZpbHRlcihoZWlnaHQgPT4gaGVpZ2h0LnRvYXN0SWQgIT09IGlkKSk7XG4gIH1cblxuICBmdW5jdGlvbiBhZGRIZWlnaHQoaGVpZ2h0OiBIZWlnaHRUKSB7XG4gICAgaGVpZ2h0cy51cGRhdGUocHJldiA9PiBbaGVpZ2h0LCAuLi5wcmV2XSk7XG4gIH1cblxuICBmdW5jdGlvbiByZXNldCgpIHtcbiAgICB0b2FzdHMuc2V0KFtdKTtcbiAgICBoZWlnaHRzLnNldChbXSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIC8vbWV0aG9kc1xuICAgIGNyZWF0ZSxcbiAgICBhZGRUb2FzdCxcbiAgICBkaXNtaXNzLFxuICAgIG1lc3NhZ2UsXG4gICAgZXJyb3IsXG4gICAgc3VjY2VzcyxcbiAgICBpbmZvLFxuICAgIHdhcm5pbmcsXG4gICAgbG9hZGluZyxcbiAgICBwcm9taXNlLFxuICAgIGN1c3RvbSxcbiAgICByZW1vdmVIZWlnaHQsXG4gICAgYWRkSGVpZ2h0LFxuICAgIHJlc2V0LFxuICAgIC8vIHNpZ25hbHNcbiAgICB0b2FzdHM6IHRvYXN0cy5hc1JlYWRvbmx5KCksXG4gICAgaGVpZ2h0czogaGVpZ2h0cy5hc1JlYWRvbmx5KCksXG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCB0b2FzdFN0YXRlID0gY3JlYXRlVG9hc3RTdGF0ZSgpO1xuXG4vLyBiaW5kIHRoaXMgdG8gdGhlIHRvYXN0IGZ1bmN0aW9uXG5mdW5jdGlvbiB0b2FzdEZ1bmN0aW9uKG1lc3NhZ2U6IHN0cmluZyB8IFR5cGU8dW5rbm93bj4sIGRhdGE/OiBFeHRlcm5hbFRvYXN0KSB7XG4gIHJldHVybiB0b2FzdFN0YXRlLmNyZWF0ZSh7XG4gICAgbWVzc2FnZSxcbiAgICAuLi5kYXRhLFxuICB9KTtcbn1cblxuY29uc3QgYmFzaWNUb2FzdCA9IHRvYXN0RnVuY3Rpb247XG5cbmV4cG9ydCBjb25zdCB0b2FzdCA9IE9iamVjdC5hc3NpZ24oYmFzaWNUb2FzdCwge1xuICBzdWNjZXNzOiB0b2FzdFN0YXRlLnN1Y2Nlc3MsXG4gIGluZm86IHRvYXN0U3RhdGUuaW5mbyxcbiAgd2FybmluZzogdG9hc3RTdGF0ZS53YXJuaW5nLFxuICBlcnJvcjogdG9hc3RTdGF0ZS5lcnJvcixcbiAgY3VzdG9tOiB0b2FzdFN0YXRlLmN1c3RvbSxcbiAgbWVzc2FnZTogdG9hc3RTdGF0ZS5tZXNzYWdlLFxuICBwcm9taXNlOiB0b2FzdFN0YXRlLnByb21pc2UsXG4gIGRpc21pc3M6IHRvYXN0U3RhdGUuZGlzbWlzcyxcbiAgbG9hZGluZzogdG9hc3RTdGF0ZS5sb2FkaW5nLFxufSk7XG4iXX0=